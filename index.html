<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wei√üwurst Bestellung</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 900px; width: 100%; margin: 0 auto; overflow: hidden; }
        .tab-navigation { display: flex; background: #f5f8fa; border-bottom: 2px solid #e1e8ed; }
        .tab-button { flex: 1; padding: 16px 20px; background: transparent; border: none; font-size: 15px; font-weight: 600; color: #666; cursor: pointer; transition: all 0.3s; position: relative; }
        .tab-button:hover { background: #e8ecef; color: #333; }
        .tab-button.active { color: #667eea; background: white; }
        .tab-button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: #667eea; }
        .tab-content { display: none; padding: 40px; }
        .tab-content.active { display: block; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 28px; color: #333; margin-bottom: 8px; }
        .header .subtitle { color: #666; font-size: 14px; }
        .icon { font-size: 48px; margin-bottom: 16px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #444; font-weight: 500; font-size: 14px; }
        input[type="text"], input[type="password"], input[type="number"], input[type="datetime-local"] { width: 100%; padding: 12px 16px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        input:focus { outline: none; border-color: #667eea; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed !important; opacity: 0.6 !important; }
        .btn-full { width: 100%; padding: 14px; font-size: 16px; margin-top: 10px; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #f5f8fa; color: #667; }
        .btn-small { padding: 8px 16px; font-size: 13px; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .message { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; display: none; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .divider { height: 1px; background: #e1e8ed; margin: 30px 0; }
        .info-box { background: #f5f8fa; padding: 16px; border-radius: 8px; font-size: 14px; color: #666; margin-bottom: 20px; line-height: 1.6; }
        .info-box.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info-box.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .password-hint { font-size: 12px; color: #999; margin-top: 4px; }
        .checkbox-container { display: flex; align-items: flex-start; margin-bottom: 20px; padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; }
        .checkbox-container input[type="checkbox"] { margin-right: 10px; margin-top: 3px; width: 18px; height: 18px; cursor: pointer; }
        .checkbox-container label { margin: 0; font-size: 13px; color: #856404; cursor: pointer; font-weight: 400; }
        .orders-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .orders-table th { background: #f5f8fa; padding: 12px; text-align: left; font-weight: 600; color: #444; border-bottom: 2px solid #e1e8ed; }
        .orders-table td { padding: 12px; border-bottom: 1px solid #e1e8ed; }
        .orders-table .item-cell { text-align: center; }
        .orders-table .name-cell { font-weight: 500; color: #333; }
        .summary-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 24px; border-radius: 12px; color: white; margin-top: 32px; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .summary-item { background: rgba(255, 255, 255, 0.15); padding: 16px; border-radius: 8px; text-align: center; }
        .summary-item-value { font-size: 28px; font-weight: 600; }
        .comparison-table { width: 100%; border-collapse: collapse; }
        .comparison-table td { padding: 10px; }
        .comparison-table .old-value { color: #dc3545; text-decoration: line-through; }
        .comparison-table .new-value { color: #28a745; font-weight: 600; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
        .modal-content { background-color: white; margin: 10% auto; padding: 30px; border-radius: 12px; max-width: 500px; }
        .modal-buttons { display: flex; gap: 12px; }
        .modal-buttons .btn { flex: 1; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div class="container">
<div class="tab-navigation">
    <button class="tab-button active" onclick="switchTab('bestellung')">ü•® Bestellung</button>
    <button class="tab-button" onclick="switchTab('uebersicht')">üìä √úbersicht</button>
    <button class="tab-button" onclick="switchTab('verwaltung')">‚öôÔ∏è Verwaltung</button>
</div>
<div id="tab-bestellung" class="tab-content active">
    <div class="header">
        <div class="icon">ü•®</div>
        <h1>Wei√üwurst Bestellung</h1>
        <p class="subtitle" id="bestellungSubtitle">L√§dt Event-Informationen...</p>
    </div>
    <div id="messageBestellung" class="message"></div>
    <div id="eventClosedWarning" class="info-box warning" style="display: none;">
        ‚ö†Ô∏è <strong>Derzeit kein aktives Event</strong><br>
        Es k√∂nnen momentan keine Bestellungen aufgegeben werden.
    </div>
    <form id="orderForm">
        <div class="form-group">
            <label for="orderName">Benutzername</label>
            <input type="text" id="orderName" placeholder="Dein Name" required>
        </div>
        <div class="form-group">
            <label for="orderPassword">Passwort (optional)</label>
            <input type="password" id="orderPassword" placeholder="Nur eingeben falls gesetzt">
            <p class="password-hint">Leer lassen, wenn du kein Passwort hast</p>
        </div>
        <div id="emptyPasswordWarningBestellung" style="display: none;">
            <div class="checkbox-container">
                <input type="checkbox" id="confirmEmptyPasswordBestellung">
                <label for="confirmEmptyPasswordBestellung">
                    <strong>‚ö†Ô∏è Ich verstehe:</strong> Ohne Passwort kann jeder unter meinem Namen bestellen.
                </label>
            </div>
        </div>
        <div class="divider"></div>
        <div class="form-group">
            <label for="wuerste">
                <img src="https://fevwursten.github.io/weisswurst.png" alt="Wei√üwurst" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 6px;">
                Anzahl Wei√üw√ºrste
            </label>
            <input type="number" id="wuerste" min="0" value="0" required>
        </div>
        <div class="form-group">
            <label for="brezn">ü•® Anzahl Brezn</label>
            <input type="number" id="brezn" min="0" value="0" required>
        </div>
        <div class="info-box" id="preisInfo" style="display: none;">
            <strong>Aktuelle Preise:</strong><br>
            Wei√üwurst: <span id="displayPreisWurst">0,00</span> ‚Ç¨ | Breze: <span id="displayPreisBreze">0,00</span> ‚Ç¨<br>
            <strong>Deine Summe: <span id="totalSum">0,00</span> ‚Ç¨</strong>
        </div>
        <button type="submit" class="btn btn-primary btn-full" id="orderSubmitBtn">Bestellung absenden</button>
    </form>
</div>
<div id="tab-uebersicht" class="tab-content">
    <div class="header">
        <div class="icon">üìä</div>
        <h1>Bestell√ºbersicht</h1>
        <p class="subtitle">Alle Bestellungen des aktuellen Events</p>
    </div>
    <div id="messageUebersicht" class="message"></div>
    <div id="loadingUebersicht" style="display: none; text-align: center;">
        <div class="spinner"></div>
        <p style="color: #667eea; margin-top: 16px;">Lade Bestellungen...</p>
    </div>
    <div id="contentUebersicht" style="display: none;">
        <table class="orders-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th class="item-cell">
                        <img src="https://fevwursten.github.io/weisswurst.png" alt="Wei√üwurst" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 4px;">
                        W√ºrste
                    </th>
                    <th class="item-cell">ü•® Brezn</th>
                    <th style="text-align: right;">Summe</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody"></tbody>
        </table>
        <div class="summary-section">
            <div style="font-size: 20px; font-weight: 600; margin-bottom: 20px; text-align: center;">üìä Gesamt√ºbersicht</div>
            <div class="summary-grid">
                <div class="summary-item">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">
                        <img src="https://fevwursten.github.io/weisswurst.png" alt="Wei√üwurst" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 4px;">
                        Wei√üw√ºrste gesamt
                    </div>
                    <div class="summary-item-value" id="totalWuerste">0</div>
                    <div style="font-size: 18px; font-weight: 500; opacity: 0.95;" id="totalWuerstePrice">0,00 ‚Ç¨</div>
                </div>
                <div class="summary-item">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ü•® Brezn gesamt</div>
                    <div class="summary-item-value" id="totalBrezn">0</div>
                    <div style="font-size: 18px; font-weight: 500; opacity: 0.95;" id="totalBreznPrice">0,00 ‚Ç¨</div>
                </div>
            </div>
        </div>
    </div>
    <div id="emptyStateUebersicht" style="display: none; text-align: center; padding: 40px; color: #999;">
        <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.5;">üìã</div>
        <h3>Keine Bestellungen vorhanden</h3>
        <p>Es wurden noch keine Bestellungen aufgegeben.</p>
    </div>
</div>
<div id="tab-verwaltung" class="tab-content">
    <div class="header">
        <div class="icon">‚öôÔ∏è</div>
        <h1 id="verwaltungTitle">Verwaltung</h1>
        <p class="subtitle" id="verwaltungSubtitle">Account & Admin</p>
    </div>
    <div id="messageVerwaltung" class="message"></div>
    <div id="loading" style="display: none; text-align: center; color: #667eea; margin: 20px 0;">
        <div class="spinner"></div>
        <p>Wird geladen...</p>
    </div>
    <div style="text-align: center; margin-bottom: 20px;">
        <button class="btn btn-secondary btn-small" onclick="toggleVerwaltungMode()" id="verwaltungModeToggle">
            Zum Admin-Bereich wechseln
        </button>
    </div>
    
    <!-- USER LOGIN -->
    <div id="userLoginSection">
        <div style="font-size: 18px; color: #333; margin-bottom: 16px; font-weight: 600;">Passwort √§ndern</div>
        <form id="userLoginForm">
            <div class="form-group">
                <label for="userName">Benutzername</label>
                <input type="text" id="userName" placeholder="Dein Name" required>
            </div>
            <div class="form-group">
                <label for="userPassword">Aktuelles Passwort</label>
                <input type="password" id="userPassword" placeholder="Passwort eingeben">
                <p class="password-hint">Leer lassen, wenn du kein Passwort gesetzt hast</p>
            </div>
            <button type="submit" class="btn btn-primary btn-full">Anmelden</button>
        </form>
    </div>
    
    <!-- ADMIN LOGIN -->
    <div id="adminLoginSection" style="display: none;">
        <form id="adminLoginForm">
            <div class="form-group">
                <label for="adminPassword">Admin-Passwort</label>
                <input type="password" id="adminPassword" placeholder="Passwort eingeben" required>
            </div>
            <button type="submit" class="btn btn-primary btn-full">Anmelden</button>
        </form>
    </div>
    
    <!-- USER PANEL -->
    <div id="userPanel" style="display: none;">
        <div class="info-box">
            Angemeldet als: <strong id="currentUser"></strong>
        </div>
        <div id="passwordChangeForm">
            <div style="font-size: 18px; color: #333; margin-bottom: 16px; font-weight: 600;">Neues Passwort setzen</div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="newPassword">Neues Passwort</label>
                    <input type="password" id="newPassword" placeholder="Beliebige L√§nge (oder leer lassen)">
                    <p class="password-hint">Beliebige L√§nge erlaubt - auch leer f√ºr kein Passwort</p>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Passwort best√§tigen</label>
                    <input type="password" id="confirmPassword" placeholder="Passwort wiederholen">
                </div>
                <div id="emptyPasswordWarning" style="display: none;">
                    <div class="checkbox-container">
                        <input type="checkbox" id="confirmEmptyPassword">
                        <label for="confirmEmptyPassword">
                            <strong>‚ö†Ô∏è Ich verstehe:</strong> Ohne Passwort kann jeder meine Bestellungen √§ndern.
                        </label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-full" id="submitPasswordBtn">Passwort √§ndern</button>
            </form>
        </div>
        <button type="button" class="btn btn-secondary btn-full" onclick="logoutUser()">Abmelden</button>
        <div id="adminRequiredWarning" style="display: none;">
            <div class="divider"></div>
            <div class="info-box">
                ‚ÑπÔ∏è <strong>Admin-Freigabe erforderlich:</strong> Bitte kontaktiere einen Administrator.
            </div>
        </div>
    </div>
    
    <!-- ADMIN PANEL -->
    <div id="adminPanel" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <span style="font-size: 18px; color: #333; font-weight: 600;">Admin-Bereich</span>
            <button class="btn btn-secondary btn-small" onclick="logoutAdmin()">Abmelden</button>
        </div>
        <div style="font-size: 18px; color: #333; margin-bottom: 16px; font-weight: 600; margin-top: 0;">üìÖ Eventplanung</div>
        <div class="info-box" id="eventStatusInfo">
            ‚ÑπÔ∏è <strong>L√§dt Event-Status...</strong>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
                <button class="btn btn-danger btn-full" onclick="showCloseEventModal()" id="closeEventBtn">üîí Event beenden</button>
                <div class="disabled-hint" id="closeEventHint" style="display: none;"></div>
            </div>
            <div>
                <button class="btn btn-success btn-full" onclick="showNewEventModal()" id="newEventBtn">‚ûï Neues Event</button>
                <div class="disabled-hint" id="newEventHint" style="display: none;"></div>
            </div>
        </div>
        <div class="divider"></div>
        <div style="font-size: 18px; color: #333; margin-bottom: 16px; font-weight: 600;">üë• Benutzerverwaltung</div>
        <div class="info-box">
            ‚ÑπÔ∏è <strong>Aktionen:</strong> Freischalten | Passwort zur√ºcksetzen | Widerrufen
        </div>
        <div id="userListContainer">
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;" id="userTable">
                <thead>
                    <tr>
                        <th style="background: #f5f8fa; padding: 12px; text-align: left; font-weight: 600; color: #444; border-bottom: 2px solid #e1e8ed;">Benutzername</th>
                        <th style="background: #f5f8fa; padding: 12px; text-align: left; font-weight: 600; color: #444; border-bottom: 2px solid #e1e8ed;">Status</th>
                        <th style="background: #f5f8fa; padding: 12px; text-align: left; font-weight: 600; color: #444; border-bottom: 2px solid #e1e8ed;">Reset aktiv</th>
                        <th style="background: #f5f8fa; padding: 12px; text-align: left; font-weight: 600; color: #444; border-bottom: 2px solid #e1e8ed;">Aktionen</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>
            <div id="emptyState" style="display: none; text-align: center; padding: 40px; color: #999;">
                <p>Keine Benutzer gefunden</p>
            </div>
        </div>
    </div>
</div>
</div>
<div id="updateModal" class="modal">
    <div class="modal-content">
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 44px; margin-bottom: 10px;">üîÑ</div>
            <h2 style="color: #333; font-size: 22px;">Bestellung aktualisieren?</h2>
        </div>
        <div style="margin-bottom: 20px;">
            <p style="text-align: center; margin-bottom: 14px; color: #666; font-size: 13px;">
                Deine bisherige Bestellung wird durch die neue ersetzt
            </p>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Bisherig</th>
                        <th></th>
                        <th>Neu</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <img src="https://fevwursten.github.io/weisswurst.png" alt="Wei√üwurst" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;">
                            W√ºrste
                        </td>
                        <td class="old-value"><span id="oldWuerste"></span> St.</td>
                        <td style="text-align: center; color: #667eea; font-size: 16px;">‚Üí</td>
                        <td class="new-value"><span id="newWuerste"></span> St.</td>
                    </tr>
                    <tr>
                        <td>ü•® Brezn</td>
                        <td class="old-value"><span id="oldBrezn"></span> St.</td>
                        <td style="text-align: center; color: #667eea; font-size: 16px;">‚Üí</td>
                        <td class="new-value"><span id="newBrezn"></span> St.</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeUpdateModal()">Abbrechen</button>
            <button class="btn btn-primary" onclick="confirmUpdate()">Aktualisieren</button>
        </div>
    </div>
</div>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbyc-i8lmUFvpJ5QxZ2EOo8FbegOnH0ez9vyBIGDynZtu12mOUtTMHKlbz4XqXls2EbwwA/exec';
const EMPTY_HASH = 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855';

let currentPreisWurst = 0;
let currentPreisBreze = 0;
let pendingOrderData = null;

async function sha256(message) {
    if (!message) return EMPTY_HASH;
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

function showMessage(text, type, section) {
    const msgEl = document.getElementById(`message${section}`);
    msgEl.textContent = text;
    msgEl.className = `message ${type}`;
    msgEl.style.display = 'block';
    setTimeout(() => msgEl.style.display = 'none', 5000);
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');
    event.target.classList.add('active');
    if (tabName === 'uebersicht') loadOrders();
}

async function loadPricesOnPageLoad() {
    try {
        const response = await fetch(`${API_URL}?type=preise`);
        const data = await response.json();
        if (data.success) {
            currentPreisWurst = data.preisWurst;
            currentPreisBreze = data.preisBreze;
            document.getElementById('displayPreisWurst').textContent = currentPreisWurst.toFixed(2).replace('.', ',');
            document.getElementById('displayPreisBreze').textContent = currentPreisBreze.toFixed(2).replace('.', ',');
            document.getElementById('preisInfo').style.display = 'block';
        }
    } catch (error) {
        console.error('Fehler beim Laden der Preise:', error);
    }
}

async function loadPricesAndEventStatus() {
    try {
        const response = await fetch(`${API_URL}?type=preise`);
        const data = await response.json();
        
        if (data.success) {
            // Preise setzen
            currentPreisWurst = data.preisWurst;
            currentPreisBreze = data.preisBreze;
            document.getElementById('displayPreisWurst').textContent = currentPreisWurst.toFixed(2).replace('.', ',');
            document.getElementById('displayPreisBreze').textContent = currentPreisBreze.toFixed(2).replace('.', ',');
            document.getElementById('preisInfo').style.display = 'block';
            
            // Event-Status pr√ºfen
            const now = new Date();
            let hasActiveEvent = false;
            let eventInfo = '';
            
            if (data.ausserplanmaessigDeadline) {
                const deadline = new Date(data.ausserplanmaessigDeadline);
                hasActiveEvent = deadline > now;
                if (hasActiveEvent) {
                    eventInfo = 'Bestellschluss: ' + deadline.toLocaleString('de-DE', { 
                        weekday: 'long', 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric',
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                }
            } else if (data.freigeschaltet) {
                hasActiveEvent = true;
                const nextFriday = new Date();
                const daysUntilFriday = (5 - nextFriday.getDay() + 7) % 7 || 7;
                nextFriday.setDate(nextFriday.getDate() + daysUntilFriday);
                nextFriday.setHours(12, 0, 0, 0);
                const fridayMorning = new Date(nextFriday);
                fridayMorning.setHours(9, 0, 0, 0);
                eventInfo = 'Freitags-Event am ' + nextFriday.toLocaleDateString('de-DE', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric' 
                }) + ' um 12:00 Uhr - Bestellschluss: ' + fridayMorning.toLocaleDateString('de-DE', { 
                    weekday: 'long',
                    day: '2-digit', 
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            
            const subtitle = document.getElementById('bestellungSubtitle');
            const orderForm = document.getElementById('orderForm');
            const eventWarning = document.getElementById('eventClosedWarning');
            
            if (hasActiveEvent) {
                subtitle.textContent = eventInfo;
                orderForm.style.display = 'block';
                eventWarning.style.display = 'none';
            } else {
                subtitle.textContent = 'Derzeit kein aktives Event';
                orderForm.style.display = 'none';
                eventWarning.style.display = 'block';
            }
        }
    } catch (error) {
        console.error('Fehler:', error);
        document.getElementById('bestellungSubtitle').textContent = 'Event-Status konnte nicht geladen werden';
        document.getElementById('orderForm').style.display = 'block';
    }
}

// Nur EINEN Call beim Laden
loadPricesAndEventStatus();


function updateTotalSum() {
    const wuerste = parseInt(document.getElementById('wuerste').value) || 0;
    const brezn = parseInt(document.getElementById('brezn').value) || 0;
    const total = (wuerste * currentPreisWurst) + (brezn * currentPreisBreze);
    document.getElementById('totalSum').textContent = total.toFixed(2).replace('.', ',');
}

document.getElementById('wuerste').addEventListener('input', updateTotalSum);
document.getElementById('brezn').addEventListener('input', updateTotalSum);

function checkEmptyPasswordWarningBestellung() {
    const password = document.getElementById('orderPassword').value;
    const warning = document.getElementById('emptyPasswordWarningBestellung');
    const submitBtn = document.getElementById('orderSubmitBtn');
    const checkbox = document.getElementById('confirmEmptyPasswordBestellung');
    if (password === '') {
        warning.style.display = 'block';
        submitBtn.disabled = !checkbox.checked;
    } else {
        warning.style.display = 'none';
        checkbox.checked = false;
        submitBtn.disabled = false;
    }
}

document.getElementById('orderPassword').addEventListener('input', checkEmptyPasswordWarningBestellung);
document.getElementById('confirmEmptyPasswordBestellung').addEventListener('change', function() {
    const submitBtn = document.getElementById('orderSubmitBtn');
    if (document.getElementById('orderPassword').value === '') {
        submitBtn.disabled = !this.checked;
    }
});

function showUpdateModal(oldWuerste, oldBrezn, newWuerste, newBrezn) {
    document.getElementById('oldWuerste').textContent = oldWuerste;
    document.getElementById('oldBrezn').textContent = oldBrezn;
    document.getElementById('newWuerste').textContent = newWuerste;
    document.getElementById('newBrezn').textContent = newBrezn;
    document.getElementById('updateModal').style.display = 'block';
}

function closeUpdateModal() {
    document.getElementById('updateModal').style.display = 'none';
    pendingOrderData = null;
    document.getElementById('orderSubmitBtn').disabled = false;
    document.getElementById('orderSubmitBtn').textContent = 'Bestellung absenden';
}

async function confirmUpdate() {
    if (!pendingOrderData) return;
    document.getElementById('updateModal').style.display = 'none';
    document.getElementById('orderSubmitBtn').textContent = 'Wird gespeichert...';
    const { name, hash, wuerste, brezn } = pendingOrderData;
    try {
        const orderUrl = `${API_URL}?action=create&name=${encodeURIComponent(name)}&hash=${hash}&wuerste=${wuerste}&brezn=${brezn}&preisWurst=${currentPreisWurst}&preisBreze=${currentPreisBreze}`;
        const orderResponse = await fetch(orderUrl);
        const orderData = await orderResponse.json();
        if (orderData.success) {
            showMessage('‚úÖ Bestellung erfolgreich aktualisiert!', 'success', 'Bestellung');
            document.getElementById('wuerste').value = 0;
            document.getElementById('brezn').value = 0;
            updateTotalSum();
            await checkEventStatusBestellung();
        } else {
            showMessage(orderData.message || 'Fehler beim Speichern!', 'error', 'Bestellung');
        }
    } catch (error) {
        showMessage('Verbindungsfehler: ' + error.message, 'error', 'Bestellung');
    } finally {
        pendingOrderData = null;
        document.getElementById('orderSubmitBtn').disabled = false;
        document.getElementById('orderSubmitBtn').textContent = 'Bestellung absenden';
    }
}
document.getElementById('orderForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('orderName').value.trim();
    const password = document.getElementById('orderPassword').value;
    const wuerste = parseInt(document.getElementById('wuerste').value) || 0;
    const brezn = parseInt(document.getElementById('brezn').value) || 0;
    if (wuerste === 0 && brezn === 0) {
        showMessage('Bitte mindestens eine Wei√üwurst oder Breze bestellen!', 'warning', 'Bestellung');
        return;
    }
    const submitBtn = document.getElementById('orderSubmitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Wird gepr√ºft...';
    try {
        const hash = await sha256(password);
        const checkUrl = `${API_URL}?action=getMyOrder&name=${encodeURIComponent(name)}&hash=${hash}`;
        const checkResponse = await fetch(checkUrl);
        const checkData = await checkResponse.json();
        if (!checkData.success && checkData.error === 'not_authenticated') {
            const registerResponse = await fetch(`${API_URL}?action=register&name=${encodeURIComponent(name)}&hash=${hash}`);
            const registerData = await registerResponse.json();
            if (!registerData.success) {
                if (registerData.error === 'name_exists') {
                    showMessage('‚ùå Falsches Passwort! Dieser Name existiert bereits.', 'error', 'Bestellung');
                } else {
                    showMessage(registerData.message || 'Registrierung fehlgeschlagen!', 'error', 'Bestellung');
                }
                submitBtn.disabled = false;
                submitBtn.textContent = 'Bestellung absenden';
                return;
            }
        }
        if (checkData.success && checkData.hasOrder) {
            pendingOrderData = { name, hash, wuerste, brezn };
            showUpdateModal(checkData.wuerste, checkData.brezn, wuerste, brezn);
            submitBtn.textContent = 'Bestellung absenden';
            return;
        }
        const orderUrl = `${API_URL}?action=create&name=${encodeURIComponent(name)}&hash=${hash}&wuerste=${wuerste}&brezn=${brezn}&preisWurst=${currentPreisWurst}&preisBreze=${currentPreisBreze}`;
        const orderResponse = await fetch(orderUrl);
        const orderData = await orderResponse.json();
        if (orderData.success) {
            showMessage('‚úÖ Bestellung erfolgreich gespeichert!', 'success', 'Bestellung');
            document.getElementById('wuerste').value = 0;
            document.getElementById('brezn').value = 0;
            updateTotalSum();
            await checkEventStatusBestellung();
        } else {
            showMessage(orderData.message || 'Fehler beim Speichern!', 'error', 'Bestellung');
        }
    } catch (error) {
        showMessage('Verbindungsfehler: ' + error.message, 'error', 'Bestellung');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Bestellung absenden';
    }
});
async function loadOrders() {
    document.getElementById('loadingUebersicht').style.display = 'block';
    document.getElementById('contentUebersicht').style.display = 'none';
    document.getElementById('emptyStateUebersicht').style.display = 'none';
    try {
        const response = await fetch(`${API_URL}?action=getAllOrders`);
        const data = await response.json();
        document.getElementById('loadingUebersicht').style.display = 'none';
        if (!data.success) {
            showMessage(data.error || 'Fehler beim Laden!', 'error', 'Uebersicht');
            document.getElementById('emptyStateUebersicht').style.display = 'block';
            return;
        }
        const orders = data.orders || [];
        if (orders.length === 0) {
            document.getElementById('emptyStateUebersicht').style.display = 'block';
            return;
        }
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '';
        let totalWuerste = 0, totalBrezn = 0, totalWuerstePrice = 0, totalBreznPrice = 0;
        orders.forEach(order => {
            const wuerste = parseInt(order.wuerste) || 0;
            const brezn = parseInt(order.brezn) || 0;
            const preisWurst = parseFloat(order.preisWurst) || 0;
            const preisBreze = parseFloat(order.preisBreze) || 0;
            const summe = (wuerste * preisWurst) + (brezn * preisBreze);
            totalWuerste += wuerste;
            totalBrezn += brezn;
            totalWuerstePrice += wuerste * preisWurst;
            totalBreznPrice += brezn * preisBreze;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="name-cell">${order.name}</td>
                <td class="item-cell">${wuerste}</td>
                <td class="item-cell">${brezn}</td>
                <td style="text-align: right; font-weight: 600; color: #667eea;">${summe.toFixed(2).replace('.', ',')} ‚Ç¨</td>
            `;
            tbody.appendChild(row);
        });
        document.getElementById('totalWuerste').textContent = totalWuerste;
        document.getElementById('totalBrezn').textContent = totalBrezn;
        document.getElementById('totalWuerstePrice').textContent = totalWuerstePrice.toFixed(2).replace('.', ',') + ' ‚Ç¨';
        document.getElementById('totalBreznPrice').textContent = totalBreznPrice.toFixed(2).replace('.', ',') + ' ‚Ç¨';
        document.getElementById('contentUebersicht').style.display = 'block';
    } catch (error) {
        document.getElementById('loadingUebersicht').style.display = 'none';
        showMessage('Verbindungsfehler: ' + error.message, 'error', 'Uebersicht');
        document.getElementById('emptyStateUebersicht').style.display = 'block';
    }
}
let currentVerwaltungMode = 'user';
let currentUsername = '';
let currentPasswordHash = '';
let userHasPassword = false;
let userHasActiveReset = false;
let eventListenersAdded = false;
let adminPassword = '';

function setLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
    document.querySelectorAll('.btn').forEach(btn => {
        if (!btn.closest('.modal') && btn.id !== 'closeEventBtn' && btn.id !== 'newEventBtn') {
            btn.disabled = show;
        }
    });
}

function toggleVerwaltungMode() {
    if (currentVerwaltungMode === 'user') {
        currentVerwaltungMode = 'admin';
        document.getElementById('verwaltungTitle').textContent = 'Admin-Bereich';
        document.getElementById('verwaltungSubtitle').textContent = 'Event & Benutzerverwaltung';
        document.getElementById('verwaltungModeToggle').textContent = 'Zur Account-Verwaltung';
        document.getElementById('userLoginSection').style.display = 'none';
        document.getElementById('userPanel').style.display = 'none';
        document.getElementById('adminLoginSection').style.display = 'block';
        document.getElementById('adminPanel').style.display = 'none';
    } else {
        currentVerwaltungMode = 'user';
        document.getElementById('verwaltungTitle').textContent = 'Account-Verwaltung';
        document.getElementById('verwaltungSubtitle').textContent = 'Passwort √§ndern';
        document.getElementById('verwaltungModeToggle').textContent = 'Zum Admin-Bereich';
        document.getElementById('userLoginSection').style.display = 'block';
        document.getElementById('adminLoginSection').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('userPanel').style.display = 'none';
    }
}

document.getElementById('userLoginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setLoading(true);
    const name = document.getElementById('userName').value.trim();
    const password = document.getElementById('userPassword').value;
    try {
        const hash = await sha256(password);
        const response = await fetch(`${API_URL}?action=login&name=${encodeURIComponent(name)}&hash=${hash}`);
        const data = await response.json();
        if (data.success) {
            currentUsername = name;
            currentPasswordHash = hash;
            userHasPassword = (hash !== EMPTY_HASH);
            userHasActiveReset = (data.resetActive === 'true');
            document.getElementById('currentUser').textContent = name;
            document.getElementById('userLoginSection').style.display = 'none';
            document.getElementById('userPanel').style.display = 'block';
            if (userHasPassword || userHasActiveReset) {
                document.getElementById('passwordChangeForm').style.display = 'block';
                document.getElementById('adminRequiredWarning').style.display = 'none';
                setTimeout(() => setupEventListeners(), 100);
            } else {
                document.getElementById('passwordChangeForm').style.display = 'none';
                document.getElementById('adminRequiredWarning').style.display = 'block';
            }
            showMessage('Erfolgreich angemeldet!', 'success', 'Verwaltung');
        } else {
            showMessage(data.message || 'Login fehlgeschlagen!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Verbindungsfehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
});

function setupEventListeners() {
    if (eventListenersAdded) return;
    const newPw = document.getElementById('newPassword');
    const confirmPw = document.getElementById('confirmPassword');
    const checkbox = document.getElementById('confirmEmptyPassword');
    newPw.addEventListener('input', checkEmptyPasswordWarning);
    confirmPw.addEventListener('input', checkEmptyPasswordWarning);
    checkbox.addEventListener('change', () => {
        const submitBtn = document.getElementById('submitPasswordBtn');
        if (newPw.value === '' && confirmPw.value === '') {
            submitBtn.disabled = !checkbox.checked;
        }
    });
    eventListenersAdded = true;
}

function checkEmptyPasswordWarning() {
    const newPw = document.getElementById('newPassword').value;
    const confirmPw = document.getElementById('confirmPassword').value;
    const warning = document.getElementById('emptyPasswordWarning');
    const submitBtn = document.getElementById('submitPasswordBtn');
    const checkbox = document.getElementById('confirmEmptyPassword');
    if (newPw === '' && confirmPw === '') {
        warning.style.display = 'block';
        submitBtn.disabled = !checkbox.checked;
    } else {
        warning.style.display = 'none';
        checkbox.checked = false;
        submitBtn.disabled = false;
    }
}

document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    if (newPassword !== confirmPassword) {
        showMessage('Passw√∂rter stimmen nicht √ºberein!', 'error', 'Verwaltung');
        return;
    }
    setLoading(true);
    try {
        const newHash = await sha256(newPassword);
        const action = userHasPassword ? 'changePasswordDirect' : 'setPassword';
        let url = `${API_URL}?action=${action}&name=${encodeURIComponent(currentUsername)}`;
        if (userHasPassword) {
            url += `&oldHash=${currentPasswordHash}&newHash=${newHash}`;
        } else {
            url += `&hash=${newHash}`;
        }
        const response = await fetch(url);
        const data = await response.json();
        if (data.success) {
            showMessage('‚úÖ Passwort erfolgreich ge√§ndert!', 'success', 'Verwaltung');
            setTimeout(() => logoutUser(), 2000);
        } else {
            showMessage(data.message || 'Fehler!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Verbindungsfehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
});

function logoutUser() {
    currentUsername = '';
    currentPasswordHash = '';
    document.getElementById('userLoginSection').style.display = 'block';
    document.getElementById('userPanel').style.display = 'none';
    document.getElementById('userLoginForm').reset();
    document.getElementById('changePasswordForm').reset();
}

document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setLoading(true);
    const password = document.getElementById('adminPassword').value;
    try {
        const response = await fetch(`${API_URL}?action=listUsers&adminPassword=${encodeURIComponent(password)}`);
        const data = await response.json();
        if (data.success) {
            adminPassword = password;
            document.getElementById('adminLoginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            showMessage('Als Admin angemeldet!', 'success', 'Verwaltung');
            loadUsers(data.users);
            await loadEventStatus();
        } else {
            showMessage('Falsches Passwort!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Verbindungsfehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
});

async function loadEventStatus() {
    const closeEventBtn = document.getElementById('closeEventBtn');
    const newEventBtn = document.getElementById('newEventBtn');
    closeEventBtn.disabled = true;
    newEventBtn.disabled = true;
    try {
        const statusResponse = await fetch(`${API_URL}?type=status`);
        const statusData = await statusResponse.json();
        const ordersResponse = await fetch(`${API_URL}?action=getAllOrders`);
        const ordersData = await ordersResponse.json();
        const now = new Date();
        let hasActiveEvent = false;
        if (statusData.ausserplanmaessigDeadline) {
            const deadline = new Date(statusData.ausserplanmaessigDeadline);
            hasActiveEvent = deadline > now;
        } else if (statusData.freigeschaltet) {
            hasActiveEvent = true;
        } else if (ordersData.success && ordersData.orders && ordersData.orders.length > 0) {
            hasActiveEvent = true;
        }
        const orderCount = (ordersData.orders || []).length;
        const eventStatusInfo = document.getElementById('eventStatusInfo');
        if (hasActiveEvent) {
            let statusText = '‚úÖ <strong>Aktuelles Event l√§uft</strong><br>';
            if (statusData.ausserplanmaessigDeadline) {
                const deadline = new Date(statusData.ausserplanmaessigDeadline);
                statusText += 'Bestellende: ' + deadline.toLocaleString('de-DE') + '<br>';
            }
            statusText += orderCount + ' Bestellung(en) vorhanden.';
            eventStatusInfo.innerHTML = statusText;
            eventStatusInfo.className = 'info-box success';
            closeEventBtn.disabled = false;
            newEventBtn.disabled = true;
        } else {
            eventStatusInfo.innerHTML = '‚ö†Ô∏è <strong>Kein aktives Event</strong><br>Keine Bestellungen vorhanden.';
            eventStatusInfo.className = 'info-box warning';
            closeEventBtn.disabled = true;
            newEventBtn.disabled = false;
        }
    } catch (error) {
        console.error('Fehler:', error);
    }
}

function loadUsers(users) {
    const tbody = document.getElementById('userTableBody');
    const table = document.getElementById('userTable');
    const emptyState = document.getElementById('emptyState');
    if (!users || users.length === 0) {
        table.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    table.style.display = 'table';
    emptyState.style.display = 'none';
    tbody.innerHTML = '';
    users.forEach(user => {
        const hasPassword = user.hasPassword === 'true';
        const resetActive = user.resetActive === 'true';
        let statusBadge = hasPassword ? '<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #d4edda; color: #155724;">Hat Passwort</span>' : '<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #fff3cd; color: #856404;">Kein Passwort</span>';
        let resetBadge = resetActive ? '<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #d1ecf1; color: #0c5460;">Ja</span>' : '<span>-</span>';
        let actionButtons = '<div style="display: flex; gap: 8px; flex-wrap: wrap;">';
        if (!hasPassword && !resetActive) {
            actionButtons += `<button class="btn btn-success btn-small" onclick="issueReset('${user.name}')">Freischalten</button>`;
        } else if (!hasPassword && resetActive) {
            actionButtons += `<button class="btn btn-danger btn-small" onclick="revokeReset('${user.name}')">Widerrufen</button>`;
        } else if (hasPassword) {
            actionButtons += `<button class="btn btn-small" style="background: #ffc107; color: #333;" onclick="resetPassword('${user.name}')">Zur√ºcksetzen</button>`;
        }
        actionButtons += '</div>';
        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="padding: 12px; border-bottom: 1px solid #e1e8ed;"><strong>${user.name}</strong></td>
            <td style="padding: 12px; border-bottom: 1px solid #e1e8ed;">${statusBadge}</td>
            <td style="padding: 12px; border-bottom: 1px solid #e1e8ed;">${resetBadge}</td>
            <td style="padding: 12px; border-bottom: 1px solid #e1e8ed;">${actionButtons}</td>
        `;
        tbody.appendChild(row);
    });
}

async function issueReset(userName) {
    if (!confirm(`${userName} f√ºr 24h freischalten?`)) return;
    setLoading(true);
    try {
        const response = await fetch(`${API_URL}?action=issueReset&adminPassword=${encodeURIComponent(adminPassword)}&userName=${encodeURIComponent(userName)}&minutes=1440`);
        const data = await response.json();
        if (data.success) {
            showMessage(`‚úÖ ${userName} freigeschaltet!`, 'success', 'Verwaltung');
            await refreshUserList();
        } else {
            showMessage(data.error || 'Fehler!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Fehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
}

async function resetPassword(userName) {
    if (!confirm(`Passwort von ${userName} zur√ºcksetzen?`)) return;
    setLoading(true);
    try {
        const response = await fetch(`${API_URL}?action=issueReset&adminPassword=${encodeURIComponent(adminPassword)}&userName=${encodeURIComponent(userName)}&minutes=1440`);
        const data = await response.json();
        if (data.success) {
            showMessage(`‚úÖ Passwort zur√ºckgesetzt!`, 'success', 'Verwaltung');
            await refreshUserList();
        } else {
            showMessage(data.error || 'Fehler!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Fehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
}

async function revokeReset(userName) {
    if (!confirm(`Freischaltung f√ºr ${userName} widerrufen?`)) return;
    setLoading(true);
    try {
        const response = await fetch(`${API_URL}?action=revokeReset&adminPassword=${encodeURIComponent(adminPassword)}&userName=${encodeURIComponent(userName)}`);
        const data = await response.json();
        if (data.success) {
            showMessage(`‚úÖ Widerrufen!`, 'success', 'Verwaltung');
            await refreshUserList();
        } else {
            showMessage(data.error || 'Fehler!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Fehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
}

async function refreshUserList() {
    try {
        const response = await fetch(`${API_URL}?action=listUsers&adminPassword=${encodeURIComponent(adminPassword)}`);
        const data = await response.json();
        if (data.success) loadUsers(data.users);
    } catch (error) {
        console.error('Fehler:', error);
    }
}

function logoutAdmin() {
    adminPassword = '';
    document.getElementById('adminLoginSection').style.display = 'block';
    document.getElementById('adminPanel').style.display = 'none';
    document.getElementById('adminLoginForm').reset();
}

function showCloseEventModal() {
    if (document.getElementById('closeEventBtn').disabled) return;
    const modal = document.createElement('div');
    modal.id = 'closeEventModalTemp';
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 44px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                <h2 style="color: #333; font-size: 22px;">Event wirklich beenden?</h2>
            </div>
            <div style="margin-bottom: 20px;">
                <div class="info-box warning">
                    <p style="margin-bottom: 8px;"><strong>Dies wird:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.6;">
                        <li>Alle aktuellen Bestellungen in die Historie verschieben</li>
                        <li>Das Bestellungen-Sheet leeren</li>
                        <li>Das aktuelle Event beenden</li>
                    </ul>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModalTemp()">Abbrechen</button>
                <button class="btn btn-danger" onclick="confirmCloseEvent()">Event beenden</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function showNewEventModal() {
    if (document.getElementById('newEventBtn').disabled) return;
    const modal = document.createElement('div');
    modal.id = 'newEventModalTemp';
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 44px; margin-bottom: 10px;">üìÖ</div>
                <h2 style="color: #333; font-size: 22px;">Neues Event starten</h2>
            </div>
            <div style="margin-bottom: 20px;">
                <div class="info-box">
                    ‚ÑπÔ∏è Lege das Event-Datum und die Bestell-Deadline fest.
                </div>
                <div class="form-group">
                    <label for="eventDate">Wann findet das Event statt?</label>
                    <input type="datetime-local" id="eventDate" required>
                </div>
                <div class="form-group">
                    <label for="eventDeadline">Bestellende (Deadline)</label>
                    <input type="datetime-local" id="eventDeadline" required>
                    <p class="password-hint">Standard: Event-Tag um 09:00 Uhr</p>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModalTemp()">Abbrechen</button>
                <button class="btn btn-success" onclick="confirmNewEvent()">Event starten</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    const eventDay = new Date();
    eventDay.setDate(eventDay.getDate() + 2);
    eventDay.setHours(12, 0, 0, 0);
    document.getElementById('eventDate').value = eventDay.toISOString().slice(0, 16);
    
    const deadline = new Date(eventDay);
    deadline.setHours(9, 0, 0, 0);
    document.getElementById('eventDeadline').value = deadline.toISOString().slice(0, 16);
    
    document.getElementById('eventDate').addEventListener('change', function() {
        const newEventDate = new Date(this.value);
        newEventDate.setHours(9, 0, 0, 0);
        document.getElementById('eventDeadline').value = newEventDate.toISOString().slice(0, 16);
    });
}

function closeModalTemp() {
    const closeModal = document.getElementById('closeEventModalTemp');
    const newModal = document.getElementById('newEventModalTemp');
    if (closeModal) closeModal.remove();
    if (newModal) newModal.remove();
}

async function confirmCloseEvent() {
    closeModalTemp();
    setLoading(true);
    try {
        const response = await fetch(`${API_URL}?action=archivieren&adminPassword=${encodeURIComponent(adminPassword)}`);
        const data = await response.json();
        if (data.success) {
            showMessage(`‚úÖ Event beendet! ${data.archived} Bestellungen archiviert.`, 'success', 'Verwaltung');
            await loadEventStatus();
        } else {
            showMessage(data.error || 'Fehler!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Fehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
}

async function confirmNewEvent() {
    const eventDate = document.getElementById('eventDate').value;
    const deadline = document.getElementById('eventDeadline').value;
    
    if (!eventDate || !deadline) {
        showMessage('Bitte beide Daten angeben!', 'error', 'Verwaltung');
        return;
    }
    
    if (new Date(deadline) > new Date(eventDate)) {
        showMessage('Bestellende muss vor Event liegen!', 'error', 'Verwaltung');
        return;
    }
    
    closeModalTemp();
    setLoading(true);
    
    try {
        const deadlineISO = new Date(deadline).toISOString();
        const response = await fetch(`${API_URL}?action=ausserplanmaessig&adminPassword=${encodeURIComponent(adminPassword)}&deadline=${encodeURIComponent(deadlineISO)}`);
        const data = await response.json();
        
        if (data.success) {
            showMessage('‚úÖ Neues Event gestartet!', 'success', 'Verwaltung');
            await loadEventStatus();
        } else {
            showMessage(data.error || 'Fehler!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Fehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
}





</script>
</body>
</html>


