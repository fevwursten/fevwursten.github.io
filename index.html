<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Wei√üwurstfr√ºhst√ºck</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Basiselemente & Layout (kurz gehalten) */
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #fafafa; color: #222; }
    header { padding: 16px; background: #7b1fa2; color: #fff; }
    main { padding: 16px; max-width: 960px; margin: 0 auto; }
    h1 { margin: 0 0 6px 0; font-size: 22px; }
    h2 { margin: 22px 0 8px; font-size: 18px; }
    .container { background:#fff; border:1px solid #eee; border-radius:10px; padding:14px; margin-bottom:16px; box-shadow:0 1px 2px rgba(0,0,0,.03); }
    label { display:block; margin:10px 0 4px; font-weight:600; }
    input[type="text"], input[type="password"], input[type="number"] { width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:15px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .actions { margin-top: 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    button { padding:10px 14px; border:0; border-radius:8px; cursor:pointer; }
    .btn-primary { background:#7b1fa2; color:#fff; }
    .btn-admin { background:#444; color:#fff; }
    .btn-danger { background:#e31b23; color:#fff; }
    .muted { color:#666; font-size:13px; }
    .success { display:none; color:#1e8b47; margin-top:8px; font-weight:600; }
    .error { display:none; color:#e31b23; margin-top:8px; font-weight:600; }
    table { width:100%; border-collapse: collapse; font-size: 14px; }
    th, td { border-bottom:1px solid #efefef; padding:8px; text-align:left; }
    th { background:#faf7ff; }
    .right { text-align:right; }

    /* Modal */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:999; }
    .modal-content { background:#fff; border-radius:12px; padding:18px 20px; width:92%; max-width:560px; box-shadow:0 10px 30px rgba(0,0,0,.2); }
    .modal h3 { margin:0 0 8px; }
    .modal-buttons { display:flex; gap:10px; justify-content:flex-end; margin-top: 14px; }
    .help-text { color:#666; font-size:12px; margin-top:6px; }

    /* Reset-Dialog ‚Äì Radios als Checkboxen mit Haken */
    #reset-username.readonly-input { background:#f2f2f5; color:#7a7a7a; border-color:#e1e1e6; }
    .choice-group { display:grid; gap:10px; margin:10px 0 2px; }
    .choice { display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none; }
    .choice input[type="radio"] { position:absolute; opacity:0; pointer-events:none; }
    .choice .box { width:20px; height:20px; border-radius:6px; border:2px solid #b9b9c5; background:#fff; display:inline-flex; align-items:center; justify-content:center; font-size:14px; transition: all .15s ease; }
    .choice:hover .box { border-color:#8f8fa3; }
    .choice input[type="radio"]:checked + .box { background:#7b1fa2; border-color:#7b1fa2; color:#fff; }
    .choice .label-text { font-weight:600; }

    /* Self-manage & Admin-Badges */
    #self-manage { margin-top: 26px; }
    #self-manage .muted { margin-bottom: 12px; display:block; }
    .user-item { display:flex; gap:10px; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid #efefef; }
    .user-name { font-weight:600; }
    .badge { display:inline-block; font-size:12px; line-height:1; padding:4px 8px; border-radius:999px; margin-right:8px; vertical-align:middle; font-weight:600; }
    .badge-pw { background:#e6f4ea; color:#1e8b47; border:1px solid #cbe9d3; }
    .badge-nopw { background:#f1f2f6; color:#6b7280; border:1px solid #e5e7eb; }
    .status-locked { color:#a15c00; font-size:12px; }
    .status-unlocked { color:#6b7280; font-size:12px; }
  </style>
</head>
<body>
  <header>
    <h1>Wei√üwurstfr√ºhst√ºck ü•®</h1>
    <div class="muted" id="status">Bereit.</div>
  </header>

  <main>
    <!-- Bestell-Formular -->
    <section class="container">
      <h2>Jetzt bestellen</h2>
      <form id="order-form">
        <label>Benutzername</label>
        <input type="text" id="name" placeholder="z. B. Andi" required>

        <label>Passwort (leer lassen falls keines gesetzt)</label>
        <input type="password" id="passwort" placeholder="falls vorhanden">

        <div class="row">
          <div>
            <label>W√ºrste</label>
            <input type="number" id="wuerste" min="0" value="0" />
          </div>
          <div>
            <label>Brezen</label>
            <input type="number" id="brezn" min="0" value="0" />
          </div>
        </div>

        <div class="actions">
          <button class="btn-primary" type="submit">Jetzt bestellen</button>
          <span class="muted">Preise gelten f√ºr neue Bestellungen.</span>
        </div>

        <div id="success" class="success"></div>
        <div id="error" class="error"></div>
      </form>
    </section>

    <!-- Aktuelle Bestellungen -->
    <section class="container">
      <h2>Aktuelle Bestellungen</h2>
      <div id="orders">L√§dt‚Ä¶</div>
    </section>

    <!-- Eigenen Account verwalten -->
    <section class="container" id="self-manage">
      <h2>Eigenen Account verwalten</h2>
      <p class="muted">Hier kannst du dein Passwort √§ndern (nur wenn du bereits eines gesetzt hast).</p>
      <button class="btn-admin" id="btn-change-password" onclick="openChangePwModal()">Passwort √§ndern</button>
    </section>

    <!-- Adminbereich (Kurzform) -->
    <section class="container">
      <h2>üîê Admin-Bereich</h2>
      <label>Admin-Passwort</label>
      <input type="password" id="admin-password" placeholder="Admin-Passwort">
      <div class="actions">
        <button class="btn-admin" onclick="ladeBenutzerListe()">Benutzer laden</button>
      </div>
      <div id="user-list" class="muted">Benutzerliste noch nicht geladen.</div>
    </section>
  </main>

  <!-- Passwort-Reset-Dialog -->
  <div id="pwreset-modal" class="modal">
    <div class="modal-content">
      <h3>Account-Optionen</h3>
      <p>F√ºr deinen Account ist ein einmaliger Passwort-Reset aktiv. W√§hle, wie du fortfahren willst.</p>

      <label>Benutzername</label>
      <input type="text" id="reset-username" class="readonly-input" readonly>

      <div class="choice-group" role="radiogroup" aria-label="Passwort-Option">
        <label class="choice">
          <input type="radio" name="pwchoice" value="nopw" checked aria-label="Ohne Passwort weitermachen">
          <span class="box">‚úì</span><span class="label-text">Ohne Passwort weitermachen</span>
        </label>
        <label class="choice">
          <input type="radio" name="pwchoice" value="setpw" aria-label="Passwort setzen">
          <span class="box">‚úì</span><span class="label-text">Passwort setzen</span>
        </label>
      </div>

      <div id="pw-fields" style="display:none;">
        <label>Neues Passwort</label>
        <input type="password" id="newpw1" placeholder="mind. 3 Zeichen" autocomplete="new-password">
        <label>Neues Passwort wiederholen</label>
        <input type="password" id="newpw2" placeholder="nochmal" autocomplete="new-password">
        <p class="help-text">Tipp: Mindestens 3 Zeichen. Vermeide deinen Namen.</p>
      </div>

      <div id="pwreset-error" class="error" style="display:none;"></div>
      <div id="pwreset-success" class="success" style="display:none;"></div>

      <div class="modal-buttons">
        <button onclick="schliessePasswortReset()" class="btn-danger">Abbrechen</button>
        <button onclick="pwresetWeiter()" class="btn-primary">Weiter</button>
      </div>
    </div>
  </div>

  <!-- Modal: Passwort √§ndern (Self-Manage) -->
  <div id="changepw-modal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:560px;width:92%;padding:20px 22px;">
      <h3>Passwort √§ndern</h3>
      <p>Gib deinen Benutzernamen, dein aktuelles Passwort und das neue Passwort ein.</p>

      <label>Benutzername</label>
      <input type="text" id="cpw-name" placeholder="Dein Benutzername">

      <label>Aktuelles Passwort</label>
      <input type="password" id="cpw-old" placeholder="aktuelles Passwort" autocomplete="current-password">

      <label>Neues Passwort</label>
      <input type="password" id="cpw-new1" placeholder="mind. 3 Zeichen" autocomplete="new-password">

      <label>Neues Passwort wiederholen</label>
      <input type="password" id="cpw-new2" placeholder="nochmal" autocomplete="new-password">

      <div id="cpw-error" class="error" style="display:none;"></div>
      <div id="cpw-success" class="success" style="display:none;"></div>

      <div class="modal-buttons">
        <button class="btn-danger" onclick="closeChangePwModal()">Abbrechen</button>
        <button class="btn-primary" onclick="submitChangePw()">Speichern</button>
      </div>
    </div>
  </div>

  <script>
    // === JSONP Setup ===
    // Trage HIER deine Apps Script Web-App URL ein:
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwdmOwK3MeR__gaScFtslQO0jfHoJhi4nzISR2l26CmSMQKCh8BxQ0gcmMq7izQiq0rng/exec';

  function jsonp(urlBase, params) {
    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      const qs = new URLSearchParams(params || {});
      qs.set('callback', cb);
      const url = urlBase + (urlBase.includes('?') ? '&' : '?') + qs.toString();
      console.log('JSONP URL:', url);

      const script = document.createElement('script');
      script.src = url;
      script.onerror = () => {
        console.error('JSONP load error for:', url);
        alert('JSONP load error.\n\nBitte √∂ffne diese URL im Inkognito:\n' + url);
        delete window[cb]; script.remove();
        reject(new Error('JSONP load error'));
      };
      window[cb] = (data) => { resolve(data); delete window[cb]; script.remove(); };
      document.body.appendChild(script);
    });
  }

    // SHA-256
    async function hashPassword(pw) {
      const enc = new TextEncoder();
      const data = enc.encode(pw || '');
      const digest = await crypto.subtle.digest('SHA-256', data);
      const bytes = Array.from(new Uint8Array(digest));
      return bytes.map(b => ('0' + b.toString(16)).slice(-2)).join('');
    }

    // Reset-Dialog
    function zeigePasswortReset(name) {
      document.getElementById('reset-username').value = name;
      document.getElementById('reset-username').classList.add('readonly-input');
      document.querySelector('input[name="pwchoice"][value="nopw"]').checked = true;
      document.getElementById('pw-fields').style.display = 'none';
      document.getElementById('pwreset-error').style.display = 'none';
      document.getElementById('pwreset-success').style.display = 'none';
      document.getElementById('pwreset-modal').style.display = 'flex';
    }
    function schliessePasswortReset() {
      document.getElementById('pwreset-modal').style.display = 'none';
    }
    document.addEventListener('change', (e) => {
      if (e.target && e.target.name === 'pwchoice') {
        const choice = document.querySelector('input[name="pwchoice"]:checked').value;
        document.getElementById('pw-fields').style.display = (choice === 'setpw') ? 'block' : 'none';
        document.getElementById('pwreset-error').style.display = 'none';
        document.getElementById('pwreset-success').style.display = 'none';
      }
    });

    async function pwresetWeiter() {
      const name = document.getElementById('reset-username').value;
      const choice = document.querySelector('input[name="pwchoice"]:checked').value;
      const err = document.getElementById('pwreset-error');
      const ok = document.getElementById('pwreset-success');
      err.style.display = 'none'; ok.style.display = 'none';

      if (choice === 'nopw') {
        if (!confirm('Wirklich ohne Passwort fortfahren? Du kannst dann k√ºnftig ohne Passwort bestellen.')) return;
        const j = await jsonp(APPS_SCRIPT_URL, { action:'finalizeNoPassword', name });
        if (j && j.success) { ok.textContent = '‚úì Ohne Passwort fortgesetzt.'; ok.style.display = 'block'; setTimeout(()=>schliessePasswortReset(), 900); }
        else { err.textContent = (j && j.message) || 'Fehler'; err.style.display = 'block'; }
        return;
      }

      const p1 = document.getElementById('newpw1').value || '';
      const p2 = document.getElementById('newpw2').value || '';
      if (!p1 && !p2) {
        if (!confirm('Wirklich kein Passwort setzen?')) return;
        document.querySelector('input[name="pwchoice"][value="nopw"]').checked = true;
        document.getElementById('pw-fields').style.display = 'none';
        return;
      }
      if (p1.length < 3) { err.textContent = '‚úó Passwort zu kurz (mind. 3 Zeichen).'; err.style.display = 'block'; return; }
      if (p1 !== p2) { err.textContent = '‚úó Passw√∂rter stimmen nicht √ºberein.'; err.style.display = 'block'; return; }

      const newHash = await hashPassword(p1);
      const j = await jsonp(APPS_SCRIPT_URL, { action:'setPassword', name, hash:newHash });
      if (j && j.success) { ok.textContent = '‚úì Passwort gespeichert.'; ok.style.display = 'block'; setTimeout(()=>schliessePasswortReset(), 900); }
      else { err.textContent = (j && j.message) || 'Fehler'; err.style.display = 'block'; }
    }

    // Self-Manage
    function openChangePwModal() {
      const mainName = (document.getElementById('name')?.value || '').trim();
      document.getElementById('cpw-name').value = mainName;
      document.getElementById('cpw-old').value = '';
      document.getElementById('cpw-new1').value = '';
      document.getElementById('cpw-new2').value = '';
      document.getElementById('cpw-error').style.display = 'none';
      document.getElementById('cpw-success').style.display = 'none';
      document.getElementById('changepw-modal').style.display = 'flex';
    }
    function closeChangePwModal() {
      document.getElementById('changepw-modal').style.display = 'none';
    }
    async function submitChangePw() {
      const name = (document.getElementById('cpw-name').value || '').trim();
      const oldPw = document.getElementById('cpw-old').value || '';
      const p1 = document.getElementById('cpw-new1').value || '';
      const p2 = document.getElementById('cpw-new2').value || '';
      const err = document.getElementById('cpw-error');
      const ok  = document.getElementById('cpw-success');
      err.style.display = 'none'; ok.style.display = 'none';
      if (!name) { err.textContent = 'Bitte Benutzernamen eingeben.'; err.style.display='block'; return; }
      if (!oldPw) { err.textContent = 'Bitte aktuelles Passwort eingeben.'; err.style.display='block'; return; }
      if (p1.length < 3) { err.textContent = 'Neues Passwort zu kurz (mind. 3 Zeichen).'; err.style.display='block'; return; }
      if (p1 !== p2) { err.textContent = 'Neue Passw√∂rter stimmen nicht √ºberein.'; err.style.display='block'; return; }
      const oldHash = await hashPassword(oldPw);
      const newHash = await hashPassword(p1);
      const j = await jsonp(APPS_SCRIPT_URL, { action:'changePassword', name, oldHash, newHash });
      if (j && j.success) { ok.textContent = '‚úì Passwort aktualisiert.'; ok.style.display = 'block'; setTimeout(()=>closeChangePwModal(), 900); }
      else {
        if (j && j.error === 'no_password_set') err.textContent = 'F√ºr diesen Account ist derzeit kein Passwort gesetzt. Verwende den Admin-Reset, um eines zu setzen.';
        else if (j && j.error === 'wrong_old_password') err.textContent = 'Aktuelles Passwort ist falsch.';
        else if (j && j.error === 'password_reset_active') err.textContent = 'Es ist ein Passwort-Reset aktiv. Bitte erst den Reset abschlie√üen.';
        else if (j && j.message) err.textContent = j.message;
        else err.textContent = '√Ñnderung fehlgeschlagen.';
        err.style.display = 'block';
      }
    }

    // Admin
    async function ladeBenutzerListe() {
      const userList = document.getElementById('user-list');
      userList.textContent = 'Lade‚Ä¶';
      const adminPassword = (document.getElementById('admin-password')?.value || '').trim();
      if (!adminPassword) { userList.textContent = 'Bitte Admin-Passwort eingeben.'; return; }
      const j = await jsonp(APPS_SCRIPT_URL, { action:'listUsers', adminPassword });
      if (!j || !j.success) { userList.textContent = (j && (j.message||j.error)) || 'Fehler.'; return; }
      const users = j.users || [];
      if (!users.length) { userList.textContent = 'Keine Benutzer.'; return; }
      userList.innerHTML = users.map(user => {
        const isLocked = user.requirePasswordReset === 'true';
        const hasPw = user.hasPassword === 'true';
        const statusClass = isLocked ? 'status-locked' : 'status-unlocked';
        const statusText = isLocked ? 'Muss PW setzen' : 'Normal';
        const badgeHtml = hasPw
          ? `<span class="badge badge-pw">hat&nbsp;PW</span>`
          : `<span class="badge badge-nopw">ohne&nbsp;PW</span>`;
        const btnHtml = isLocked
          ? `<button class="btn-admin" title="Hebt den ausgestellten Passwort-Reset sofort auf" onclick="revokeReset('${(user.name||'').replace(/'/g, "\\'")}')">Reset widerrufen</button>`
          : `<button class="btn-admin" title="Erlaubt einmalig, beim n√§chsten Login ein Passwort zu setzen (24&nbsp;h g√ºltig)" onclick="issueReset('${(user.name||'').replace(/'/g, "\\'")}', 1440)">Reset erlauben (24 h)</button>`;
        return `
          <div class="user-item">
            <span class="user-name">${badgeHtml}${user.name}</span>
            <span class="user-status ${statusClass}">${statusText}</span>
            ${btnHtml}
          </div>
        `;
      }).join('');
    }
    async function issueReset(userName, minutes=1440) {
      const adminPassword = (document.getElementById('admin-password')?.value || '').trim();
      if (!adminPassword) { alert('Bitte Admin-Passwort eingeben.'); return; }
      const j = await jsonp(APPS_SCRIPT_URL, { action:'issueReset', adminPassword, userName, minutes });
      if (j && j.success) ladeBenutzerListe(); else alert((j && (j.message||j.error)) || 'Fehler.');
    }
    async function revokeReset(userName) {
      const adminPassword = (document.getElementById('admin-password')?.value || '').trim();
      if (!adminPassword) { alert('Bitte Admin-Passwort eingeben.'); return; }
      const j = await jsonp(APPS_SCRIPT_URL, { action:'revokeReset', adminPassword, userName });
      if (j && j.success) ladeBenutzerListe(); else alert((j && (j.message||j.error)) || 'Fehler.');
    }

    // Bestellungen laden
    async function laden() {
      const target = document.getElementById('orders');
      target.textContent = 'Lade‚Ä¶';
      const data = await jsonp(APPS_SCRIPT_URL, {}); // Default: Liste
      if (!Array.isArray(data) || !data.length) { target.textContent = 'Keine Bestellungen.'; return; }
      let sumW=0, sumB=0;
      let html = '<table><thead><tr><th>Name</th><th class="right">W√ºrste</th><th class="right">Brezen</th></tr></thead><tbody>';
      data.forEach(row => {
        sumW += Number(row.Wuerste)||0; sumB += Number(row.Brezn)||0;
        html += `<tr><td>${row.Name}</td><td class="right">${row.Wuerste}</td><td class="right">${row.Brezn}</td></tr>`;
      });
      html += `</tbody><tfoot><tr><th>Summe</th><th class="right">${sumW}</th><th class="right">${sumB}</th></tr></tfoot></table>`;
      target.innerHTML = html;
    }

    // Submit mit Update-Confirm
    document.getElementById('order-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true; submitBtn.textContent = 'Wird verarbeitet...';

      const name = (document.getElementById('name').value || '').trim();
      const passwort = (document.getElementById('passwort').value || '').trim();
      const w = parseInt(document.getElementById('wuerste').value, 10) || 0;
      const b = parseInt(document.getElementById('brezn').value, 10) || 0;
      const errEl = document.getElementById('error');
      const okEl  = document.getElementById('success');
      errEl.style.display = 'none'; okEl.style.display = 'none';

      try {
        const passwortHash = await hashPassword(passwort);

        // Login-Probe: aktiver Reset?
        const probe = await jsonp(APPS_SCRIPT_URL, { action:'login', name, hash:passwortHash });
        if (probe && (probe.requirePasswordReset === 'true' || probe.error === 'password_reset_required')) {
          zeigePasswortReset(name);
          submitBtn.disabled = false; submitBtn.textContent = 'Jetzt bestellen';
          return;
        }

        // Bestehende Bestellung?
        let existing = null;
        const chk = await jsonp(APPS_SCRIPT_URL, { action:'getMyOrder', name, hash:passwortHash });
        if (chk && chk.success && chk.hasOrder) existing = chk;

        if (existing) {
          const altW = Number(existing.wuerste)||0;
          const altB = Number(existing.brezn)||0;
          const ok = confirm(
            'Du hast bereits eine Bestellung.\n\n' +
            'Alt: ' + altW + ' W, ' + altB + ' B\n' +
            'Neu: ' + w + ' W, ' + b + ' B\n\n' +
            'Soll die Bestellung aktualisiert werden?'
          );
          if (!ok) { submitBtn.disabled=false; submitBtn.textContent='Jetzt bestellen'; return; }
          const upd = await jsonp(APPS_SCRIPT_URL, { action:'update', name, hash:passwortHash, wuerste:String(w), brezn:String(b) });
          if (upd && upd.success) { okEl.textContent='‚úì Bestellung aktualisiert!'; okEl.style.display='block'; }
          else throw new Error((upd && (upd.message||upd.error)) || 'Update fehlgeschlagen');
        } else {
          const crt = await jsonp(APPS_SCRIPT_URL, { action:'create', name, hash:passwortHash, wuerste:String(w), brezn:String(b), preisWurst:'0', preisBreze:'0' });
          if (crt && crt.success) { okEl.textContent='‚úì Bestellung erfolgreich!'; okEl.style.display='block'; }
          else throw new Error((crt && (crt.message||crt.error)) || 'Erstellen fehlgeschlagen');
        }

        document.getElementById('order-form').reset();
        await laden();

      } catch (err) {
        console.error(err);
        errEl.textContent = '‚úó ' + (err?.message || 'Unbekannter Fehler');
        errEl.style.display = 'block';
      } finally {
        submitBtn.disabled = false; submitBtn.textContent = 'Jetzt bestellen';
      }
    });

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      laden();
    });
  </script>
</body>
</html>
