
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Resource Hints: Verbindungen schon vorwärmen -->
	<link rel="preconnect" href="https://script.google.com">
	<link rel="dns-prefetch" href="https://script.google.com">

	<link rel="preconnect" href="https://fevwursten.github.io">
	<link rel="dns-prefetch" href="https://fevwursten.github.io">

    <title>Weißwurst Bestellung</title>
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
        /* ⬇️⬇️⬇️ GEÄNDERT - CI Gradient Rot/Dunkelrot ⬇️⬇️⬇️ */
        background: linear-gradient(135deg, #b9052d 0%, #6e031b 100%); 
        /* ⬆️⬆️⬆️ ⬆️⬆️⬆️ */
        min-height: 100vh; 
        padding: 20px; 
    }
    .container { background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(185,5,45,0.3); max-width: 900px; width: 100%; margin: 0 auto; overflow: hidden; }
    
    .tab-navigation { display: flex; background: #f5f8fa; border-bottom: 2px solid #e1e8ed; }
    .tab-button { flex: 1; padding: 16px 20px; background: transparent; border: none; font-size: 15px; font-weight: 600; color: #666; cursor: pointer; transition: all 0.3s; position: relative; }
    .tab-button:hover { background: #e8ecef; color: #333; }
    
    /* ⬇️⬇️⬇️ GEÄNDERT - CI Rot für aktiven Tab ⬇️⬇️⬇️ */
    .tab-button.active { color: #b9052d; background: white; }
    .tab-button.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: #b9052d; }
    /* ⬆️⬆️⬆️ ⬆️⬆️⬆️ */
    
    .tab-content { display: none; padding: 40px; }
    .tab-content.active { display: block; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: 28px; color: #333; margin-bottom: 8px; }
    .header .subtitle { color: #666; font-size: 14px; }
    .icon { font-size: 48px; margin-bottom: 16px; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #444; font-weight: 500; font-size: 14px; }
    input[type="text"], input[type="password"], input[type="number"], input[type="datetime-local"] { width: 100%; padding: 12px 16px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
    
    /* ⬇️⬇️⬇️ GEÄNDERT - CI Rot für Focus ⬇️⬇️⬇️ */
    input:focus { outline: none; border-color: #b9052d; }
    /* ⬆️⬆️⬆️ ⬆️⬆️⬆️ */
    
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
    .btn:disabled { background: #ccc !important; cursor: not-allowed !important; opacity: 0.6 !important; }
    .btn-full { width: 100%; padding: 14px; font-size: 16px; margin-top: 10px; }
    
    /* ⬇️⬇️⬇️ GEÄNDERT - CI Gradient Rot/Dunkelrot ⬇️⬇️⬇️ */
    .btn-primary { background: linear-gradient(135deg, #b9052d 0%, #dd0038 100%); color: white; }
    .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(185, 5, 45, 0.4); }
    /* ⬆️⬆️⬆️ ⬆️⬆️⬆️ */
    
    .btn-secondary { background: #f5f8fa; color: #667; }
    .btn-small { padding: 8px 16px; font-size: 13px; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-success { background: #28a745; color: white; }
    
    .message { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; display: none; }
    .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .message.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    
    .divider { height: 1px; background: #e1e8ed; margin: 30px 0; }
    .info-box { background: #f5f8fa; padding: 16px; border-radius: 8px; font-size: 14px; color: #666; margin-bottom: 20px; line-height: 1.6; }
    .info-box.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    .info-box.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    
    .password-hint { font-size: 12px; color: #999; margin-top: 4px; }
    .checkbox-container { display: flex; align-items: flex-start; margin-bottom: 20px; padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; }
    .checkbox-container input[type="checkbox"] { margin-right: 10px; margin-top: 3px; width: 18px; height: 18px; cursor: pointer; }
    .checkbox-container label { margin: 0; font-size: 13px; color: #856404; cursor: pointer; font-weight: 400; }
    
    .orders-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .orders-table th { background: #f5f8fa; padding: 12px; text-align: left; font-weight: 600; color: #444; border-bottom: 2px solid #e1e8ed; }
    .orders-table td { padding: 12px; border-bottom: 1px solid #e1e8ed; }
    .orders-table .item-cell { text-align: center; }
    .orders-table .name-cell { font-weight: 500; color: #333; }
    
    /* ⬇️⬇️⬇️ GEÄNDERT - CI Gradient für Summary ⬇️⬇️⬇️ */
    .summary-section { 
        background: linear-gradient(135deg, #b9052d 0%, #6e031b 100%); 
        padding: 24px; 
        border-radius: 12px; 
        color: white; 
        margin-top: 32px; 
    }
    /* ⬆️⬆️⬆️ ⬆️⬆️⬆️ */
    
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .summary-item { background: rgba(255, 255, 255, 0.15); padding: 16px; border-radius: 8px; text-align: center; }
    .summary-item-value { font-size: 28px; font-weight: 600; }
    
    .comparison-table { width: 100%; border-collapse: collapse; }
    .comparison-table td { padding: 10px; }
    .comparison-table .old-value { color: #dc3545; text-decoration: line-through; }
    .comparison-table .new-value { color: #28a745; font-weight: 600; }
    
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
    .modal-content { background-color: white; margin: 10% auto; padding: 30px; border-radius: 12px; max-width: 500px; }
    .modal-buttons { display: flex; gap: 12px; }
    .modal-buttons .btn { flex: 1; }
    
    /* ⬇️⬇️⬇️ GEÄNDERT - CI Rot für Spinner ⬇️⬇️⬇️ */
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #b9052d; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
    /* ⬆️⬆️⬆️ ⬆️⬆️⬆️ */
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    
    @media (max-width: 600px) {
        .form-row { grid-template-columns: 1fr; }
    }
/* ⬇️⬇️⬇️ HIER EINFÜGEN - Accordion Styles ⬇️⬇️⬇️ */

.event-accordion {
    margin-bottom: 16px;
    border: 2px solid #e1e8ed;
    border-radius: 12px;
    overflow: hidden;
    background: white;
}

.event-accordion.current {
    border-color: #b9052d;
    box-shadow: 0 4px 12px rgba(185, 5, 45, 0.15);
}

.event-header {
    padding: 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f5f8fa;
    transition: all 0.3s;
    user-select: none;
}

.event-accordion.current .event-header {
    background: linear-gradient(135deg, #b9052d 0%, #6e031b 100%);
    color: white;
}

.event-header:hover {
    background: #e8ecef;
}

.event-accordion.current .event-header:hover {
    background: linear-gradient(135deg, #dd0038 0%, #b9052d 100%);
}

.event-title {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.event-badge {
    background: #b9052d;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.event-stats {
    display: flex;
    gap: 20px;
    font-size: 14px;
    color: #666;
}

.event-accordion.current .event-stats {
    color: rgba(255, 255, 255, 0.9);
}

.event-toggle {
    font-size: 24px;
    transition: transform 0.3s;
    color: #b9052d;
}

.event-accordion.current .event-toggle {
    color: white;
}

.event-toggle.open {
    transform: rotate(180deg);
}

.event-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.event-content.open {
    max-height: 2000px;
    transition: max-height 0.5s ease-in;
}

.event-content-inner {
    padding: 20px;
}

/* ⬆️⬆️⬆️ BIS HIER ⬆️⬆️⬆️ */

/* Hall of Fame Styles */
.podium-container {
    display: flex;
    justify-content: center;
    align-items: flex-end;
    gap: 20px;
    margin: 40px auto;
    padding: 20px;
    max-width: 800px;
}

.podium-place {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 150px;
    flex: 1;
}

.podium-box {
    background: linear-gradient(135deg, #b9052d 0%, #8a0421 100%);
    border-radius: 8px;
    padding: 15px;
    width: 100%;
    text-align: center;
    color: white;
    box-shadow: 0 4px 15px rgba(185,5,45,0.3);
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
}

.podium-box.first {
    height: 180px;
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    color: #000;
}

.podium-box.second {
    height: 150px;
    background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%);
    color: #000;
}

.podium-box.third {
    height: 120px;
    background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
    color: #fff;
}

.podium-medal {
    font-size: 48px;
    margin-bottom: 10px;
}

.podium-name {
    font-size: 18px;
    font-weight: 600;
    margin: 10px 0 5px 0;
}

.podium-stats {
    font-size: 14px;
    opacity: 0.9;
    line-height: 1.6;
}

.ranking-list {
    max-width: 800px;
    margin: 30px auto;
}

.ranking-item {
    background: white;
    border-radius: 8px;
    padding: 15px 20px;
    margin: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.ranking-rank {
    font-size: 20px;
    font-weight: 600;
    color: #b9052d;
    min-width: 40px;
}

.ranking-details {
    flex: 1;
    display: flex;
    justify-content: space-between;
    margin-left: 20px;
    flex-wrap: wrap;
    gap: 10px;
}

.year-filter {
    text-align: center;
    margin: 30px auto 20px auto;
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    max-width: 600px;
}

.filter-toggle {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.filter-btn {
    padding: 12px 30px;
    font-size: 16px;
    font-weight: 600;
    border: 2px solid #e1e8ed;
    border-radius: 8px;
    background: white;
    color: #666;
    cursor: pointer;
    transition: all 0.3s;
}

.filter-btn:hover {
    border-color: #b9052d;
    color: #b9052d;
    transform: translateY(-2px);
}

.filter-btn.active {
    background: #b9052d;
    color: white;
    border-color: #b9052d;
}

.year-filter select {
    padding: 10px 20px;
    font-size: 16px;
    border: 2px solid #b9052d;
    border-radius: 8px;
    margin: 0;
    cursor: pointer;
    background: white;
}

.year-filter label {
    font-size: 16px;
    color: #333;
}






</style>
	
	

</style>

</head>
<body>
<div class="container">
<div class="tab-navigation">
    <button class="tab-button active" onclick="switchTab('bestellung')">🥨 Bestellung</button>
    <button class="tab-button" onclick="switchTab('uebersicht')">📊 Übersicht</button>
	<button class="tab-button" onclick="switchTab('halloffame')">🏆 Hall of Fame</button>
    <button class="tab-button" onclick="switchTab('verwaltung')">⚙️ Verwaltung</button>
</div>
<div id="tab-bestellung" class="tab-content active">
<div class="header">
    <div class="icon">🥨</div>
    <h1>Weißwurst Bestellung</h1>
    <h2 id="eventDatum" style="font-size: 24px; color: #667eea; margin: 16px 0 8px 0; font-weight: 600;">Lädt Event-Informationen...</h2>
    <p class="subtitle" id="bestellungSubtitle" style="font-size: 14px; color: #999;">Bestellschluss wird geladen...</p>
</div>

    <div id="messageBestellung" class="message"></div>
    <div id="eventClosedWarning" class="info-box warning" style="display: none;">
        ⚠️ <strong>Derzeit kein aktives Event</strong><br>
        Es können momentan keine Bestellungen aufgegeben werden.
    </div>
<form id="orderForm">
    <div class="form-row">
        <div class="form-group">
            <label for="orderName">Benutzername</label>
            <input type="text" id="orderName" placeholder="Dein Name" required autocomplete="username">
        </div>
        <div class="form-group">
            <label for="orderPassword">Passwort (optional)</label>
            <input type="password" id="orderPassword" placeholder="Nur eingeben falls gesetzt" autocomplete="current-password">
            <!-- ⬇️⬇️⬇️ HIER BLEIBT DER HINT - INNERHALB der form-group ⬇️⬇️⬇️ -->
            <p class="password-hint">Leer lassen, wenn du kein Passwort hast</p>
        </div>
    </div>
    
    <div id="emptyPasswordWarningBestellung" style="display: none;">
        <div class="checkbox-container">
            <input type="checkbox" id="confirmEmptyPasswordBestellung">
            <label for="confirmEmptyPasswordBestellung">
                <strong>⚠️ Ich verstehe:</strong> Ohne Passwort kann jeder unter meinem Namen bestellen.
            </label>
        </div>
    </div>
    
    <div class="divider"></div>
    
    <div class="form-row">
        <div class="form-group">
            <label for="wuerste">
                <img
  src="https://fevwursten.github.io/weisswurst.png"
  alt="Weißwurst"
  width="20"
  height="20"
  loading="lazy"
  style="vertical-align: middle; margin-right: 6px;"
>

                Anzahl Weißwürste
            </label>
            <input type="number" id="wuerste" min="0" value="0" required autocomplete="off">
        </div>
        <div class="form-group">
            <label for="brezn">🥨 Anzahl Brezn</label>
            <input type="number" id="brezn" min="0" value="0" required autocomplete="off">
        </div>
    </div>
    
    <div class="info-box" id="preisInfo" style="display: none;">
        <strong>Aktuelle Preise:</strong><br>
        Weißwurst: <span id="displayPreisWurst">0,00</span> € | Breze: <span id="displayPreisBreze">0,00</span> €<br>
        <strong>Deine Summe: <span id="totalSum">0,00</span> €</strong>
    </div>
    
    <button type="submit" class="btn btn-primary btn-full" id="orderSubmitBtn">Bestellung absenden</button>
</form>

<!-- ⬇️⬇️⬇️ HIER EINFÜGEN - Übersicht nach Bestellung ⬇️⬇️⬇️ -->

<div class="divider"></div>

<div style="font-size: 20px; color: #333; margin-bottom: 20px; font-weight: 600; text-align: center;">
    📊 Aktuelle Bestellungen
</div>

<div id="messageBestellungUebersicht" class="message"></div>

<div id="loadingBestellungUebersicht" style="display: none; text-align: center;">
    <div class="spinner"></div>
    <p style="color: #667eea; margin-top: 16px;">Lade Bestellungen...</p>
</div>

<div id="contentBestellungUebersicht" style="display: none;">
    <table class="orders-table">
        <thead>
            <tr>
                <th>Name</th>
                <th class="item-cell">
                    <img src="https://fevwursten.github.io/weisswurst.png" alt="Weißwurst" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 4px;">
                    Würste
                </th>
                <th class="item-cell">🥨 Brezn</th>
                <th style="text-align: right;">Summe</th>
            </tr>
        </thead>
        <tbody id="ordersTableBodyBestellung"></tbody>
    </table>
    <div class="summary-section">
        <div style="font-size: 20px; font-weight: 600; margin-bottom: 20px; text-align: center;">📊 Gesamtübersicht</div>
        <div class="summary-grid">
            <div class="summary-item">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">
                    <img src="https://fevwursten.github.io/weisswurst.png" alt="Weißwurst" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 4px;">
                    Weißwürste gesamt
                </div>
                <div class="summary-item-value" id="totalWuersteBestellung">0</div>
                <div style="font-size: 18px; font-weight: 500; opacity: 0.95;" id="totalWuerstePriceBestellung">0,00 €</div>
            </div>
            <div class="summary-item">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">🥨 Brezn gesamt</div>
                <div class="summary-item-value" id="totalBreznBestellung">0</div>
                <div style="font-size: 18px; font-weight: 500; opacity: 0.95;" id="totalBreznPriceBestellung">0,00 €</div>
            </div>
        </div>
    </div>
</div>

<div id="emptyStateBestellungUebersicht" style="display: none; text-align: center; padding: 40px; color: #999;">
    <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.5;">📋</div>
    <h3>Keine Bestellungen vorhanden</h3>
    <p>Es wurden noch keine Bestellungen aufgegeben.</p>
</div>


</div>
<!-- ÜBERSICHT TAB -->
<div id="tab-uebersicht" class="tab-content">
    <div class="header">
        <div class="icon">📊</div>
        <h1>Event-Übersicht</h1>
        <p class="subtitle">Aktuelles Event und Bestellhistorie</p>
    </div>
    
    <div id="messageUebersicht" class="message"></div>
    
    <div id="loadingUebersicht" style="display: none; text-align: center;">
        <div class="spinner"></div>
        <p style="color: #b9052d; margin-top: 16px;">Lade Events...</p>
    </div>
    
    <div id="contentUebersicht" style="display: none;">
        <!-- Events werden hier dynamisch eingefügt -->
        <div id="eventsContainer"></div>
    </div>
    
    <div id="emptyStateUebersicht" style="display: none; text-align: center; padding: 40px; color: #999;">
        <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.5;">📋</div>
        <h3>Keine Events vorhanden</h3>
        <p>Es wurden noch keine Events durchgeführt.</p>
    </div>
</div>

<div id="tab-halloffame" class="tab-content">
    <h2 style="text-align: center; color: #b9052d;">🏆 Hall of Fame</h2>
    
	<div class="year-filter">
		<div class="filter-toggle">
			<button class="filter-btn active" data-filter="alltime" onclick="toggleFilter('alltime')">
				📊 All-Time
			</button>
			<button class="filter-btn" data-filter="yearly" onclick="toggleFilter('yearly')">
				📅 Jährlich
			</button>
		</div>
		
		<div id="yearSelectContainer" style="display: none; margin-top: 15px;">
			<label style="font-weight: 600; margin-right: 10px;">Jahr auswählen:</label>
			<select id="yearSelect" onchange="loadHallOfFame()">
				<option value="2025">2025</option>
				<option value="2024">2024</option>
				<option value="2023">2023</option>
			</select>
		</div>
	</div>


    <div id="loadingHallOfFame" style="text-align: center; padding: 40px;">
        <p>Lade Rangliste...</p>
    </div>
    
    <div id="podiumContainer" style="display: none;"></div>
    <div id="rankingList" class="ranking-list" style="display: none;"></div>
</div>




<div id="tab-verwaltung" class="tab-content">
    <div class="header">
        <div class="icon">⚙️</div>
        <h1 id="verwaltungTitle">Verwaltung</h1>
        <p class="subtitle" id="verwaltungSubtitle">Account & Admin</p>
    </div>
    <div id="messageVerwaltung" class="message"></div>
    <div id="loading" style="display: none; text-align: center; color: #667eea; margin: 20px 0;">
        <div class="spinner"></div>
        <p>Wird geladen...</p>
    </div>
    <div style="text-align: center; margin-bottom: 20px;">
        <button class="btn btn-secondary btn-small" onclick="toggleVerwaltungMode()" id="verwaltungModeToggle">
            Zum Admin-Bereich wechseln
        </button>
    </div>
    
    <!-- USER LOGIN -->
    <div id="userLoginSection">
        <div style="font-size: 18px; color: #333; margin-bottom: 16px; font-weight: 600;">Passwort ändern</div>
        <form id="userLoginForm">
            <div class="form-group">
                <label for="userName">Benutzername</label>
                <input type="text" id="userName" placeholder="Dein Name" required>
            </div>
            <div class="form-group">
                <label for="userPassword">Aktuelles Passwort</label>
                <input type="password" id="userPassword" placeholder="Passwort eingeben">
                <p class="password-hint">Leer lassen, wenn du kein Passwort gesetzt hast</p>
            </div>
            <button type="submit" class="btn btn-primary btn-full">Anmelden</button>
        </form>
    </div>
    
    <!-- ADMIN LOGIN -->
    <div id="adminLoginSection" style="display: none;">
        <form id="adminLoginForm">
            <div class="form-group">
                <label for="adminPassword">Admin-Passwort</label>
                <input type="password" id="adminPassword" placeholder="Passwort eingeben" required>
            </div>
            <button type="submit" class="btn btn-primary btn-full">Anmelden</button>
        </form>
    </div>
    
    <!-- USER PANEL -->
    <div id="userPanel" style="display: none;">
        <div class="info-box">
            Angemeldet als: <strong id="currentUser"></strong>
        </div>
        <div id="passwordChangeForm">
            <div style="font-size: 18px; color: #333; margin-bottom: 16px; font-weight: 600;">Neues Passwort setzen</div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="newPassword">Neues Passwort</label>
                    <input type="password" id="newPassword" placeholder="Beliebige Länge (oder leer lassen)">
                    <p class="password-hint">Beliebige Länge erlaubt - auch leer für kein Passwort</p>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Passwort bestätigen</label>
                    <input type="password" id="confirmPassword" placeholder="Passwort wiederholen">
                </div>
                <div id="emptyPasswordWarning" style="display: none;">
                    <div class="checkbox-container">
                        <input type="checkbox" id="confirmEmptyPassword">
                        <label for="confirmEmptyPassword">
                            <strong>⚠️ Ich verstehe:</strong> Ohne Passwort kann jeder meine Bestellungen ändern.
                        </label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-full" id="submitPasswordBtn">Passwort ändern</button>
            </form>
        </div>
        <button type="button" class="btn btn-secondary btn-full" onclick="logoutUser()">Abmelden</button>
        <div id="adminRequiredWarning" style="display: none;">
            <div class="divider"></div>
            <div class="info-box">
                ℹ️ <strong>Admin-Freigabe erforderlich:</strong> Bitte kontaktiere einen Administrator.
            </div>
        </div>
    </div>
    
    <!-- ADMIN PANEL -->
    <div id="adminPanel" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <span style="font-size: 18px; color: #333; font-weight: 600;">Admin-Bereich</span>
            <button class="btn btn-secondary btn-small" onclick="logoutAdmin()">Abmelden</button>
        </div>
        <div style="font-size: 18px; color: #333; margin-bottom: 16px; font-weight: 600; margin-top: 0;">📅 Eventplanung</div>
        <div class="info-box" id="eventStatusInfo">
            ℹ️ <strong>Lädt Event-Status...</strong>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
                <button class="btn btn-danger btn-full" onclick="showCloseEventModal()" id="closeEventBtn">🔒 Event beenden</button>
                <div class="disabled-hint" id="closeEventHint" style="display: none;"></div>
            </div>
            <div>
                <button class="btn btn-success btn-full" onclick="showNewEventModal()" id="newEventBtn">➕ Neues Event</button>
                <div class="disabled-hint" id="newEventHint" style="display: none;"></div>
            </div>
        </div>
		<div class="divider"></div>
		<div style="font-size: 18px; color: #333; margin-bottom: 16px; font-weight: 600;">💰 Preise verwalten</div>

		<div class="info-box" id="currentPreisInfo" style="margin-bottom: 16px;">
			ℹ️ Aktuelle Preise werden geladen...
		</div>

		<form id="preiseForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
			<div class="form-group" style="margin-bottom: 0;">
				<label for="adminPreisWurst">
					<img src="https://fevwursten.github.io/weisswurst.png" alt="Weißwurst" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;">
					Preis Weißwurst (€)
				</label>
				<input type="number" id="adminPreisWurst" step="0.01" min="0" required>
			</div>
			<div class="form-group" style="margin-bottom: 0;">
				<label for="adminPreisBreze">🥨 Preis Breze (€)</label>
				<input type="number" id="adminPreisBreze" step="0.01" min="0" required>
			</div>
		</form>

		<button type="button" class="btn btn-primary btn-full" onclick="updatePreise()" id="updatePreiseBtn">
			Preise aktualisieren
		</button>		
        <div class="divider"></div>
        <div style="font-size: 18px; color: #333; margin-bottom: 16px; font-weight: 600;">👥 Benutzerverwaltung</div>
        <div class="info-box">
            ℹ️ <strong>Aktionen:</strong> Freischalten | Passwort zurücksetzen | Widerrufen
        </div>
        <div id="userListContainer">
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;" id="userTable">
                <thead>
                    <tr>
                        <th style="background: #f5f8fa; padding: 12px; text-align: left; font-weight: 600; color: #444; border-bottom: 2px solid #e1e8ed;">Benutzername</th>
                        <th style="background: #f5f8fa; padding: 12px; text-align: left; font-weight: 600; color: #444; border-bottom: 2px solid #e1e8ed;">Status</th>
                        <th style="background: #f5f8fa; padding: 12px; text-align: left; font-weight: 600; color: #444; border-bottom: 2px solid #e1e8ed;">Reset aktiv</th>
                        <th style="background: #f5f8fa; padding: 12px; text-align: left; font-weight: 600; color: #444; border-bottom: 2px solid #e1e8ed;">Aktionen</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>
            <div id="emptyState" style="display: none; text-align: center; padding: 40px; color: #999;">
                <p>Keine Benutzer gefunden</p>
            </div>
        </div>
    </div>
</div>
</div>
<div id="updateModal" class="modal">
    <div class="modal-content">
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 44px; margin-bottom: 10px;">🔄</div>
            <h2 style="color: #333; font-size: 22px;">Bestellung aktualisieren?</h2>
        </div>
        <div style="margin-bottom: 20px;">
            <p style="text-align: center; margin-bottom: 14px; color: #666; font-size: 13px;">
                Deine bisherige Bestellung wird durch die neue ersetzt
            </p>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Bisherig</th>
                        <th></th>
                        <th>Neu</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <img src="https://fevwursten.github.io/weisswurst.png" alt="Weißwurst" style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;">
                            Würste
                        </td>
                        <td class="old-value"><span id="oldWuerste"></span> St.</td>
                        <td style="text-align: center; color: #667eea; font-size: 16px;">→</td>
                        <td class="new-value"><span id="newWuerste"></span> St.</td>
                    </tr>
                    <tr>
                        <td>🥨 Brezn</td>
                        <td class="old-value"><span id="oldBrezn"></span> St.</td>
                        <td style="text-align: center; color: #667eea; font-size: 16px;">→</td>
                        <td class="new-value"><span id="newBrezn"></span> St.</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeUpdateModal()">Abbrechen</button>
            <button class="btn btn-primary" onclick="confirmUpdate()">Aktualisieren</button>
        </div>
    </div>
</div>
<script>
function translateDateToDeutsch(datum) {
    if (!datum || typeof datum !== 'string') return datum;
    
    // 1. ISO-Timestamp abfangen (z.B. "2025-10-24T22:00:00.000Z")
    if (datum.match(/^\d{4}-\d{2}-\d{2}T/)) {
        const date = new Date(datum);
        const germanDays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return germanDays[date.getDay()] + ', ' + day + '.' + month + '.' + year;
    }
    
    // 2. Alte Einträge mit englischen Abkürzungen
    const replacements = {
        'Mon': 'Montag',
        'Tue': 'Dienstag', 
        'Wed': 'Mittwoch',
        'Thu': 'Donnerstag',
        'Fri': 'Freitag',
        'Sat': 'Samstag',
        'Sun': 'Sonntag'
    };
    
    let result = datum;
    for (const [eng, ger] of Object.entries(replacements)) {
        result = result.replace(eng, ger);
    }
    
    // 3. Neue Einträge nur mit Datum → Wochentag hinzufügen
    if (datum.match(/^\d{2}\.\d{2}\.\d{4}$/)) {
        const [day, month, year] = datum.split('.');
        const date = new Date(year, month - 1, day);
        const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
        return days[date.getDay()] + ', ' + datum;
    }
    
    return result;
}



const API_URL = 'https://script.google.com/macros/s/AKfycbyc-i8lmUFvpJ5QxZ2EOo8FbegOnH0ez9vyBIGDynZtu12mOUtTMHKlbz4XqXls2EbwwA/exec';
const EMPTY_HASH = 'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855';

let currentPreisWurst = 0;
let currentPreisBreze = 0;
let pendingOrderData = null;

async function sha256(message) {
    if (!message) return EMPTY_HASH;
    const msgBuffer = new TextEncoder().encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

function showMessage(text, type, section) {
    const msgEl = document.getElementById(`message${section}`);
    msgEl.textContent = text;
    msgEl.className = `message ${type}`;
    msgEl.style.display = 'block';
    setTimeout(() => msgEl.style.display = 'none', 5000);
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');
    event.target.classList.add('active');
    if (tabName === 'uebersicht') loadUebersicht(); // <-- GEÄNDERT
	if (tabName === 'halloffame') loadHallOfFame();

}

async function loadPricesOnPageLoad() {
    try {
        const response = await fetch(`${API_URL}?type=preise`);
        const data = await response.json();
        if (data.success) {
            currentPreisWurst = data.preisWurst;
            currentPreisBreze = data.preisBreze;
            document.getElementById('displayPreisWurst').textContent = currentPreisWurst.toFixed(2).replace('.', ',');
            document.getElementById('displayPreisBreze').textContent = currentPreisBreze.toFixed(2).replace('.', ',');
            document.getElementById('preisInfo').style.display = 'block';
        }
    } catch (error) {
        console.error('Fehler beim Laden der Preise:', error);
    }
}

async function loadPricesAndEventStatus() {
    try {
        const response = await fetch(`${API_URL}?type=preise`);
        const data = await response.json();
        
        if (data.success) {
            // Preise setzen
            currentPreisWurst = data.preisWurst;
            currentPreisBreze = data.preisBreze;
            document.getElementById('displayPreisWurst').textContent = currentPreisWurst.toFixed(2).replace('.', ',');
            document.getElementById('displayPreisBreze').textContent = currentPreisBreze.toFixed(2).replace('.', ',');
            document.getElementById('preisInfo').style.display = 'block';
            
            // Event-Status prüfen
            const now = new Date();
            let hasActiveEvent = false;
            let eventDatum = '';
            let bestellschluss = '';
            
            if (data.ausserplanmaessigDeadline) {
                const deadline = new Date(data.ausserplanmaessigDeadline);
                hasActiveEvent = deadline > now;
                if (hasActiveEvent) {
                    // Event-Datum ist der Tag der Deadline um 12:00 Uhr
                    const eventDate = new Date(deadline);
                    eventDate.setHours(12, 0, 0, 0);
                    
                    eventDatum = eventDate.toLocaleDateString('de-DE', { 
                        weekday: 'long', 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric'
                    }) + ' um 12:00 Uhr';
                    
                    bestellschluss = 'Bestellschluss: ' + deadline.toLocaleDateString('de-DE', { 
                        weekday: 'short',
                        day: '2-digit', 
                        month: '2-digit',
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }) + ' Uhr';
                }
            } else if (data.freigeschaltet) {
                hasActiveEvent = true;
                const nextFriday = new Date();
                const daysUntilFriday = (5 - nextFriday.getDay() + 7) % 7 || 7;
                nextFriday.setDate(nextFriday.getDate() + daysUntilFriday);
                nextFriday.setHours(12, 0, 0, 0);
                
                const fridayMorning = new Date(nextFriday);
                fridayMorning.setHours(9, 0, 0, 0);
                
                eventDatum = 'Freitags-Event: ' + nextFriday.toLocaleDateString('de-DE', { 
                    weekday: 'long',
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric' 
                }) + ' um 12:00 Uhr';
                
                bestellschluss = 'Bestellschluss: ' + fridayMorning.toLocaleDateString('de-DE', { 
                    weekday: 'short',
                    day: '2-digit', 
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) + ' Uhr';
            }
            
            const eventDatumEl = document.getElementById('eventDatum');
            const subtitleEl = document.getElementById('bestellungSubtitle');
            const orderForm = document.getElementById('orderForm');
            const eventWarning = document.getElementById('eventClosedWarning');
            
            if (hasActiveEvent) {
                eventDatumEl.textContent = eventDatum;
                eventDatumEl.style.color = '#667eea';
                subtitleEl.textContent = bestellschluss;
                orderForm.style.display = 'block';
                eventWarning.style.display = 'none';
            } else {
                eventDatumEl.textContent = 'Derzeit kein aktives Event';
                eventDatumEl.style.color = '#dc3545';
                subtitleEl.textContent = 'Keine Bestellungen möglich';
                orderForm.style.display = 'none';
                eventWarning.style.display = 'block';
            }
        }
    } catch (error) {
        console.error('Fehler:', error);
        document.getElementById('eventDatum').textContent = 'Event-Status konnte nicht geladen werden';
        document.getElementById('bestellungSubtitle').textContent = '';
        document.getElementById('orderForm').style.display = 'block';
    }
}


// Nur EINEN Call beim Laden
loadPricesAndEventStatus();


function updateTotalSum() {
    const wuerste = parseInt(document.getElementById('wuerste').value) || 0;
    const brezn = parseInt(document.getElementById('brezn').value) || 0;
    const total = (wuerste * currentPreisWurst) + (brezn * currentPreisBreze);
    document.getElementById('totalSum').textContent = total.toFixed(2).replace('.', ',');
}

document.getElementById('wuerste').addEventListener('input', updateTotalSum);
document.getElementById('brezn').addEventListener('input', updateTotalSum);

function checkEmptyPasswordWarningBestellung() {
    const password = document.getElementById('orderPassword').value;
    const warning = document.getElementById('emptyPasswordWarningBestellung');
    const submitBtn = document.getElementById('orderSubmitBtn');
    const checkbox = document.getElementById('confirmEmptyPasswordBestellung');
    if (password === '') {
        warning.style.display = 'block';
        submitBtn.disabled = !checkbox.checked;
    } else {
        warning.style.display = 'none';
        checkbox.checked = false;
        submitBtn.disabled = false;
    }
}

document.getElementById('orderPassword').addEventListener('input', checkEmptyPasswordWarningBestellung);
document.getElementById('confirmEmptyPasswordBestellung').addEventListener('change', function() {
    const submitBtn = document.getElementById('orderSubmitBtn');
    if (document.getElementById('orderPassword').value === '') {
        submitBtn.disabled = !this.checked;
    }
});
checkEmptyPasswordWarningBestellung();

function showUpdateModal(oldWuerste, oldBrezn, newWuerste, newBrezn) {
    document.getElementById('oldWuerste').textContent = oldWuerste;
    document.getElementById('oldBrezn').textContent = oldBrezn;
    document.getElementById('newWuerste').textContent = newWuerste;
    document.getElementById('newBrezn').textContent = newBrezn;
    document.getElementById('updateModal').style.display = 'block';
}

function closeUpdateModal() {
    document.getElementById('updateModal').style.display = 'none';
    pendingOrderData = null;
    document.getElementById('orderSubmitBtn').disabled = false;
    document.getElementById('orderSubmitBtn').textContent = 'Bestellung absenden';
}

async function confirmUpdate() {
    if (!pendingOrderData) return;
    document.getElementById('updateModal').style.display = 'none';
    document.getElementById('orderSubmitBtn').textContent = 'Wird gespeichert...';
    const { name, hash, wuerste, brezn } = pendingOrderData;
    try {
        const orderUrl = `${API_URL}?action=create&name=${encodeURIComponent(name)}&hash=${hash}&wuerste=${wuerste}&brezn=${brezn}&preisWurst=${currentPreisWurst}&preisBreze=${currentPreisBreze}`;
        const orderResponse = await fetch(orderUrl);
        const orderData = await orderResponse.json();
        if (orderData.success) {
            showMessage('✅ Bestellung erfolgreich aktualisiert!', 'success', 'Bestellung');
            document.getElementById('wuerste').value = 0;
            document.getElementById('brezn').value = 0;
            updateTotalSum();
           // await loadPricesAndEventStatus();
			await loadOrdersInBestellung(); // <-- HINZUFÜGEN
        } else {
            showMessage(orderData.message || 'Fehler beim Speichern!', 'error', 'Bestellung');
        }
    } catch (error) {
        showMessage('Verbindungsfehler: ' + error.message, 'error', 'Bestellung');
    } finally {
        pendingOrderData = null;
        document.getElementById('orderSubmitBtn').disabled = false;
        document.getElementById('orderSubmitBtn').textContent = 'Bestellung absenden';
    }
}
document.getElementById('orderForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('orderName').value.trim();
    const password = document.getElementById('orderPassword').value;
    const wuerste = parseInt(document.getElementById('wuerste').value) || 0;
    const brezn = parseInt(document.getElementById('brezn').value) || 0;
    if (wuerste === 0 && brezn === 0) {
        showMessage('Bitte mindestens eine Weißwurst oder Breze bestellen!', 'warning', 'Bestellung');
        return;
    }
    const submitBtn = document.getElementById('orderSubmitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Wird geprüft...';
    try {
        const hash = await sha256(password);
        const checkUrl = `${API_URL}?action=getMyOrder&name=${encodeURIComponent(name)}&hash=${hash}`;
        const checkResponse = await fetch(checkUrl);
        const checkData = await checkResponse.json();
        if (!checkData.success && checkData.error === 'not_authenticated') {
            const registerResponse = await fetch(`${API_URL}?action=register&name=${encodeURIComponent(name)}&hash=${hash}`);
            const registerData = await registerResponse.json();
            if (!registerData.success) {
                if (registerData.error === 'name_exists') {
                    showMessage('❌ Falsches Passwort! Dieser Name existiert bereits.', 'error', 'Bestellung');
                } else {
                    showMessage(registerData.message || 'Registrierung fehlgeschlagen!', 'error', 'Bestellung');
                }
                submitBtn.disabled = false;
                submitBtn.textContent = 'Bestellung absenden';
                return;
            }
        }
        if (checkData.success && checkData.hasOrder) {
            pendingOrderData = { name, hash, wuerste, brezn };
            showUpdateModal(checkData.wuerste, checkData.brezn, wuerste, brezn);
            submitBtn.textContent = 'Bestellung absenden';
            return;
        }
        const orderUrl = `${API_URL}?action=create&name=${encodeURIComponent(name)}&hash=${hash}&wuerste=${wuerste}&brezn=${brezn}&preisWurst=${currentPreisWurst}&preisBreze=${currentPreisBreze}`;
        const orderResponse = await fetch(orderUrl);
        const orderData = await orderResponse.json();
        if (orderData.success) {
            showMessage('✅ Bestellung erfolgreich gespeichert!', 'success', 'Bestellung');
            document.getElementById('wuerste').value = 0;
            document.getElementById('brezn').value = 0;
            updateTotalSum();
           // await loadPricesAndEventStatus();
			await loadOrdersInBestellung(); // <-- HINZUFÜGEN
        } else {
            showMessage(orderData.message || 'Fehler beim Speichern!', 'error', 'Bestellung');
        }
    } catch (error) {
        showMessage('Verbindungsfehler: ' + error.message, 'error', 'Bestellung');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Bestellung absenden';
    }
});
async function loadOrders() {
    document.getElementById('loadingUebersicht').style.display = 'block';
    document.getElementById('contentUebersicht').style.display = 'none';
    document.getElementById('emptyStateUebersicht').style.display = 'none';
    try {
        const response = await fetch(`${API_URL}?action=getAllOrders`);
        const data = await response.json();
        document.getElementById('loadingUebersicht').style.display = 'none';
        if (!data.success) {
            showMessage(data.error || 'Fehler beim Laden!', 'error', 'Uebersicht');
            document.getElementById('emptyStateUebersicht').style.display = 'block';
            return;
        }
        const orders = data.orders || [];
        if (orders.length === 0) {
            document.getElementById('emptyStateUebersicht').style.display = 'block';
            return;
        }
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '';
        let totalWuerste = 0, totalBrezn = 0, totalWuerstePrice = 0, totalBreznPrice = 0;
        orders.forEach(order => {
            const wuerste = parseInt(order.wuerste) || 0;
            const brezn = parseInt(order.brezn) || 0;
            const preisWurst = parseFloat(order.preisWurst) || 0;
            const preisBreze = parseFloat(order.preisBreze) || 0;
            const summe = (wuerste * preisWurst) + (brezn * preisBreze);
            totalWuerste += wuerste;
            totalBrezn += brezn;
            totalWuerstePrice += wuerste * preisWurst;
            totalBreznPrice += brezn * preisBreze;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="name-cell">${order.name}</td>
                <td class="item-cell">${wuerste}</td>
                <td class="item-cell">${brezn}</td>
                <td style="text-align: right; font-weight: 600; color: #667eea;">${summe.toFixed(2).replace('.', ',')} €</td>
            `;
            tbody.appendChild(row);
        });
        document.getElementById('totalWuerste').textContent = totalWuerste;
        document.getElementById('totalBrezn').textContent = totalBrezn;
        document.getElementById('totalWuerstePrice').textContent = totalWuerstePrice.toFixed(2).replace('.', ',') + ' €';
        document.getElementById('totalBreznPrice').textContent = totalBreznPrice.toFixed(2).replace('.', ',') + ' €';
        document.getElementById('contentUebersicht').style.display = 'block';
    } catch (error) {
        document.getElementById('loadingUebersicht').style.display = 'none';
        showMessage('Verbindungsfehler: ' + error.message, 'error', 'Uebersicht');
        document.getElementById('emptyStateUebersicht').style.display = 'block';
    }
}

async function loadOrdersInBestellung() {
    document.getElementById('loadingBestellungUebersicht').style.display = 'block';
    document.getElementById('contentBestellungUebersicht').style.display = 'none';
    document.getElementById('emptyStateBestellungUebersicht').style.display = 'none';
    
    try {
        const response = await fetch(`${API_URL}?action=getAllOrders`);
        const data = await response.json();
        
        document.getElementById('loadingBestellungUebersicht').style.display = 'none';
        
        if (!data.success) {
            document.getElementById('emptyStateBestellungUebersicht').style.display = 'block';
            return;
        }
        
        const orders = data.orders || [];
        
        if (orders.length === 0) {
            document.getElementById('emptyStateBestellungUebersicht').style.display = 'block';
            return;
        }
        
        const tbody = document.getElementById('ordersTableBodyBestellung');
        tbody.innerHTML = '';
        
        let totalWuerste = 0, totalBrezn = 0, totalWuerstePrice = 0, totalBreznPrice = 0;
        
        orders.forEach(order => {
            const wuerste = parseInt(order.wuerste) || 0;
            const brezn = parseInt(order.brezn) || 0;
            const preisWurst = parseFloat(order.preisWurst) || 0;
            const preisBreze = parseFloat(order.preisBreze) || 0;
            const summe = (wuerste * preisWurst) + (brezn * preisBreze);
            
            totalWuerste += wuerste;
            totalBrezn += brezn;
            totalWuerstePrice += wuerste * preisWurst;
            totalBreznPrice += brezn * preisBreze;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="name-cell">${order.name}</td>
                <td class="item-cell">${wuerste}</td>
                <td class="item-cell">${brezn}</td>
                <td style="text-align: right; font-weight: 600; color: #667eea;">${summe.toFixed(2).replace('.', ',')} €</td>
            `;
            tbody.appendChild(row);
        });
        
        document.getElementById('totalWuersteBestellung').textContent = totalWuerste;
        document.getElementById('totalBreznBestellung').textContent = totalBrezn;
        document.getElementById('totalWuerstePriceBestellung').textContent = totalWuerstePrice.toFixed(2).replace('.', ',') + ' €';
        document.getElementById('totalBreznPriceBestellung').textContent = totalBreznPrice.toFixed(2).replace('.', ',') + ' €';
        
        document.getElementById('contentBestellungUebersicht').style.display = 'block';
    } catch (error) {
        document.getElementById('loadingBestellungUebersicht').style.display = 'none';
        document.getElementById('emptyStateBestellungUebersicht').style.display = 'block';
    }
}

function afterFirstPaint(fn) {
  if ('requestIdleCallback' in window) {
    // Wenn der Browser es kann, starte erst wenn er nichts Wichtiges mehr zu tun hat
    requestIdleCallback(fn, { timeout: 1500 });
  } else {
    // Falls der Browser das nicht kann (älter), starte einfach nach einer kurzen Pause
    setTimeout(fn, 0);
  }
}




// Beim Laden der Seite auch anzeigen
window.addEventListener('DOMContentLoaded', () => {
  afterFirstPaint(loadOrdersInBestellung);
});



let currentVerwaltungMode = 'user';
let currentUsername = '';
let currentPasswordHash = '';
let userHasPassword = false;
let userHasActiveReset = false;
let eventListenersAdded = false;
let adminPassword = '';

function setLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
    document.querySelectorAll('.btn').forEach(btn => {
        if (!btn.closest('.modal') && btn.id !== 'closeEventBtn' && btn.id !== 'newEventBtn') {
            btn.disabled = show;
        }
    });
}

function toggleVerwaltungMode() {
    if (currentVerwaltungMode === 'user') {
        currentVerwaltungMode = 'admin';
        document.getElementById('verwaltungTitle').textContent = 'Admin-Bereich';
        document.getElementById('verwaltungSubtitle').textContent = 'Event & Benutzerverwaltung';
        document.getElementById('verwaltungModeToggle').textContent = 'Zur Account-Verwaltung';
        document.getElementById('userLoginSection').style.display = 'none';
        document.getElementById('userPanel').style.display = 'none';
        document.getElementById('adminLoginSection').style.display = 'block';
        document.getElementById('adminPanel').style.display = 'none';
    } else {
        currentVerwaltungMode = 'user';
        document.getElementById('verwaltungTitle').textContent = 'Account-Verwaltung';
        document.getElementById('verwaltungSubtitle').textContent = 'Passwort ändern';
        document.getElementById('verwaltungModeToggle').textContent = 'Zum Admin-Bereich';
        document.getElementById('userLoginSection').style.display = 'block';
        document.getElementById('adminLoginSection').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';
        document.getElementById('userPanel').style.display = 'none';
    }
}

document.getElementById('userLoginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setLoading(true);
    const name = document.getElementById('userName').value.trim();
    const password = document.getElementById('userPassword').value;
    try {
        const hash = await sha256(password);
        const response = await fetch(`${API_URL}?action=login&name=${encodeURIComponent(name)}&hash=${hash}`);
        const data = await response.json();
        if (data.success) {
            currentUsername = name;
            currentPasswordHash = hash;
            userHasPassword = (hash !== EMPTY_HASH);
            userHasActiveReset = (data.resetActive === 'true');
            document.getElementById('currentUser').textContent = name;
            document.getElementById('userLoginSection').style.display = 'none';
            document.getElementById('userPanel').style.display = 'block';
            if (userHasPassword || userHasActiveReset) {
                document.getElementById('passwordChangeForm').style.display = 'block';
                document.getElementById('adminRequiredWarning').style.display = 'none';
                setTimeout(() => setupEventListeners(), 100);
            } else {
                document.getElementById('passwordChangeForm').style.display = 'none';
                document.getElementById('adminRequiredWarning').style.display = 'block';
            }
            showMessage('Erfolgreich angemeldet!', 'success', 'Verwaltung');
        } else {
            showMessage(data.message || 'Login fehlgeschlagen!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Verbindungsfehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
});

function setupEventListeners() {
    if (eventListenersAdded) return;
    const newPw = document.getElementById('newPassword');
    const confirmPw = document.getElementById('confirmPassword');
    const checkbox = document.getElementById('confirmEmptyPassword');
    newPw.addEventListener('input', checkEmptyPasswordWarning);
    confirmPw.addEventListener('input', checkEmptyPasswordWarning);
    checkbox.addEventListener('change', () => {
        const submitBtn = document.getElementById('submitPasswordBtn');
        if (newPw.value === '' && confirmPw.value === '') {
            submitBtn.disabled = !checkbox.checked;
        }
    });
    eventListenersAdded = true;
}

function checkEmptyPasswordWarning() {
    const newPw = document.getElementById('newPassword').value;
    const confirmPw = document.getElementById('confirmPassword').value;
    const warning = document.getElementById('emptyPasswordWarning');
    const submitBtn = document.getElementById('submitPasswordBtn');
    const checkbox = document.getElementById('confirmEmptyPassword');
    if (newPw === '' && confirmPw === '') {
        warning.style.display = 'block';
        submitBtn.disabled = !checkbox.checked;
    } else {
        warning.style.display = 'none';
        checkbox.checked = false;
        submitBtn.disabled = false;
    }
}

document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    if (newPassword !== confirmPassword) {
        showMessage('Passwörter stimmen nicht überein!', 'error', 'Verwaltung');
        return;
    }
    setLoading(true);
    try {
        const newHash = await sha256(newPassword);
        const action = userHasPassword ? 'changePasswordDirect' : 'setPassword';
        let url = `${API_URL}?action=${action}&name=${encodeURIComponent(currentUsername)}`;
        if (userHasPassword) {
            url += `&oldHash=${currentPasswordHash}&newHash=${newHash}`;
        } else {
            url += `&hash=${newHash}`;
        }
        const response = await fetch(url);
        const data = await response.json();
        if (data.success) {
            showMessage('✅ Passwort erfolgreich geändert!', 'success', 'Verwaltung');
            setTimeout(() => logoutUser(), 2000);
        } else {
            showMessage(data.message || 'Fehler!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Verbindungsfehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
});

function logoutUser() {
    currentUsername = '';
    currentPasswordHash = '';
    document.getElementById('userLoginSection').style.display = 'block';
    document.getElementById('userPanel').style.display = 'none';
    document.getElementById('userLoginForm').reset();
    document.getElementById('changePasswordForm').reset();
}

document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setLoading(true);
    const password = document.getElementById('adminPassword').value;
    try {
        const response = await fetch(`${API_URL}?action=listUsers&adminPassword=${encodeURIComponent(password)}`);
        const data = await response.json();
        if (data.success) {
            adminPassword = password;
            document.getElementById('adminLoginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            showMessage('Als Admin angemeldet!', 'success', 'Verwaltung');
            loadUsers(data.users);
            await loadEventStatus();
        } else {
            showMessage('Falsches Passwort!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Verbindungsfehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
});

async function loadEventStatus() {
    const closeEventBtn = document.getElementById('closeEventBtn');
    const newEventBtn = document.getElementById('newEventBtn');
    closeEventBtn.disabled = true;
    newEventBtn.disabled = true;
    try {
        const statusResponse = await fetch(`${API_URL}?type=status`);
        const statusData = await statusResponse.json();
        const ordersResponse = await fetch(`${API_URL}?action=getAllOrders`);
        const ordersData = await ordersResponse.json();
        const now = new Date();
        let hasActiveEvent = false;
        if (statusData.ausserplanmaessigDeadline) {
            const deadline = new Date(statusData.ausserplanmaessigDeadline);
            hasActiveEvent = deadline > now;
        } else if (statusData.freigeschaltet) {
            hasActiveEvent = true;
        } else if (ordersData.success && ordersData.orders && ordersData.orders.length > 0) {
            hasActiveEvent = true;
        }
        const orderCount = (ordersData.orders || []).length;
        const eventStatusInfo = document.getElementById('eventStatusInfo');
        if (hasActiveEvent) {
            let statusText = '✅ <strong>Aktuelles Event läuft</strong><br>';
            if (statusData.ausserplanmaessigDeadline) {
                const deadline = new Date(statusData.ausserplanmaessigDeadline);
                statusText += 'Bestellende: ' + deadline.toLocaleString('de-DE') + '<br>';
            }
            statusText += orderCount + ' Bestellung(en) vorhanden.';
            eventStatusInfo.innerHTML = statusText;
            eventStatusInfo.className = 'info-box success';
            closeEventBtn.disabled = false;
            newEventBtn.disabled = true;
        } else {
            eventStatusInfo.innerHTML = '⚠️ <strong>Kein aktives Event</strong><br>Keine Bestellungen vorhanden.';
            eventStatusInfo.className = 'info-box warning';
            closeEventBtn.disabled = true;
            newEventBtn.disabled = false;
        }
    await loadCurrentPreise(); // <-- DIESE ZEILE HINZUFÜGEN
	} catch (error) {
        console.error('Fehler:', error);
    }
}

function loadUsers(users) {
    const tbody = document.getElementById('userTableBody');
    const table = document.getElementById('userTable');
    const emptyState = document.getElementById('emptyState');
    if (!users || users.length === 0) {
        table.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    table.style.display = 'table';
    emptyState.style.display = 'none';
    tbody.innerHTML = '';
    users.forEach(user => {
        const hasPassword = user.hasPassword === 'true';
        const resetActive = user.resetActive === 'true';
        let statusBadge = hasPassword ? '<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #d4edda; color: #155724;">Hat Passwort</span>' : '<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #fff3cd; color: #856404;">Kein Passwort</span>';
        let resetBadge = resetActive ? '<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; background: #d1ecf1; color: #0c5460;">Ja</span>' : '<span>-</span>';
        let actionButtons = '<div style="display: flex; gap: 8px; flex-wrap: wrap;">';
        if (!hasPassword && !resetActive) {
            actionButtons += `<button class="btn btn-success btn-small" onclick="issueReset('${user.name}')">Freischalten</button>`;
        } else if (!hasPassword && resetActive) {
            actionButtons += `<button class="btn btn-danger btn-small" onclick="revokeReset('${user.name}')">Widerrufen</button>`;
        } else if (hasPassword) {
            actionButtons += `<button class="btn btn-small" style="background: #ffc107; color: #333;" onclick="resetPassword('${user.name}')">Zurücksetzen</button>`;
        }
        actionButtons += '</div>';
        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="padding: 12px; border-bottom: 1px solid #e1e8ed;"><strong>${user.name}</strong></td>
            <td style="padding: 12px; border-bottom: 1px solid #e1e8ed;">${statusBadge}</td>
            <td style="padding: 12px; border-bottom: 1px solid #e1e8ed;">${resetBadge}</td>
            <td style="padding: 12px; border-bottom: 1px solid #e1e8ed;">${actionButtons}</td>
        `;
        tbody.appendChild(row);
    });
}

async function issueReset(userName) {
    if (!confirm(`${userName} für 24h freischalten?`)) return;
    setLoading(true);
    try {
        const response = await fetch(`${API_URL}?action=issueReset&adminPassword=${encodeURIComponent(adminPassword)}&userName=${encodeURIComponent(userName)}&minutes=1440`);
        const data = await response.json();
        if (data.success) {
            showMessage(`✅ ${userName} freigeschaltet!`, 'success', 'Verwaltung');
            await refreshUserList();
        } else {
            showMessage(data.error || 'Fehler!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Fehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
}

async function resetPassword(userName) {
    if (!confirm(`Passwort von ${userName} zurücksetzen?`)) return;
    setLoading(true);
    try {
        const response = await fetch(`${API_URL}?action=issueReset&adminPassword=${encodeURIComponent(adminPassword)}&userName=${encodeURIComponent(userName)}&minutes=1440`);
        const data = await response.json();
        if (data.success) {
            showMessage(`✅ Passwort zurückgesetzt!`, 'success', 'Verwaltung');
            await refreshUserList();
        } else {
            showMessage(data.error || 'Fehler!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Fehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
}

async function revokeReset(userName) {
    if (!confirm(`Freischaltung für ${userName} widerrufen?`)) return;
    setLoading(true);
    try {
        const response = await fetch(`${API_URL}?action=revokeReset&adminPassword=${encodeURIComponent(adminPassword)}&userName=${encodeURIComponent(userName)}`);
        const data = await response.json();
        if (data.success) {
            showMessage(`✅ Widerrufen!`, 'success', 'Verwaltung');
            await refreshUserList();
        } else {
            showMessage(data.error || 'Fehler!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Fehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
}

async function refreshUserList() {
    try {
        const response = await fetch(`${API_URL}?action=listUsers&adminPassword=${encodeURIComponent(adminPassword)}`);
        const data = await response.json();
        if (data.success) loadUsers(data.users);
    } catch (error) {
        console.error('Fehler:', error);
    }
}

function logoutAdmin() {
    adminPassword = '';
    document.getElementById('adminLoginSection').style.display = 'block';
    document.getElementById('adminPanel').style.display = 'none';
    document.getElementById('adminLoginForm').reset();
}

async function loadCurrentPreise() {
    try {
        const response = await fetch(`${API_URL}?type=preise`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('adminPreisWurst').value = data.preisWurst.toFixed(2);
            document.getElementById('adminPreisBreze').value = data.preisBreze.toFixed(2);
            document.getElementById('currentPreisInfo').innerHTML = 
                `💰 <strong>Aktuelle Preise:</strong> Weißwurst ${data.preisWurst.toFixed(2)} € | Breze ${data.preisBreze.toFixed(2)} €`;
        }
    } catch (error) {
        console.error('Fehler beim Laden der Preise:', error);
    }
}

async function updatePreise() {
    const preisWurst = document.getElementById('adminPreisWurst').value;
    const preisBreze = document.getElementById('adminPreisBreze').value;
    
    if (!preisWurst || !preisBreze) {
        showMessage('Bitte beide Preise angeben!', 'error', 'Verwaltung');
        return;
    }
    
    if (parseFloat(preisWurst) < 0 || parseFloat(preisBreze) < 0) {
        showMessage('Preise müssen positiv sein!', 'error', 'Verwaltung');
        return;
    }
    
    setLoading(true);
    
    try {
        const response = await fetch(`${API_URL}?action=setPreise&adminPassword=${encodeURIComponent(adminPassword)}&preisWurst=${preisWurst}&preisBreze=${preisBreze}`);
        const data = await response.json();
        
        if (data.success) {
            showMessage('✅ Preise erfolgreich aktualisiert!', 'success', 'Verwaltung');
            await loadCurrentPreise();
            await loadPricesAndEventStatus();
        } else {
            showMessage(data.error || 'Fehler beim Speichern!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Fehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
}

function showCloseEventModal() {
    if (document.getElementById('closeEventBtn').disabled) return;
    const modal = document.createElement('div');
    modal.id = 'closeEventModalTemp';
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 44px; margin-bottom: 10px;">⚠️</div>
                <h2 style="color: #333; font-size: 22px;">Event wirklich beenden?</h2>
            </div>
            <div style="margin-bottom: 20px;">
                <div class="info-box warning">
                    <p style="margin-bottom: 8px;"><strong>Dies wird:</strong></p>
                    <ul style="margin-left: 20px; line-height: 1.6;">
                        <li>Alle aktuellen Bestellungen in die Historie verschieben</li>
                        <li>Das Bestellungen-Sheet leeren</li>
                        <li>Das aktuelle Event beenden</li>
                    </ul>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModalTemp()">Abbrechen</button>
                <button class="btn btn-danger" onclick="confirmCloseEvent()">Event beenden</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function showNewEventModal() {
    if (document.getElementById('newEventBtn').disabled) return;
    const modal = document.createElement('div');
    modal.id = 'newEventModalTemp';
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 44px; margin-bottom: 10px;">📅</div>
                <h2 style="color: #333; font-size: 22px;">Neues Event starten</h2>
            </div>
            <div style="margin-bottom: 20px;">
                <div class="info-box">
                    ℹ️ Lege das Event-Datum und die Bestell-Deadline fest.
                </div>
                <div class="form-group">
                    <label for="eventDate">Wann findet das Event statt?</label>
                    <input type="datetime-local" id="eventDate" required>
                </div>
                <div class="form-group">
                    <label for="eventDeadline">Bestellende (Deadline)</label>
                    <input type="datetime-local" id="eventDeadline" required>
                    <p class="password-hint">Standard: Event-Tag um 09:00 Uhr</p>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModalTemp()">Abbrechen</button>
                <button class="btn btn-success" onclick="confirmNewEvent()">Event starten</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    const eventDay = new Date();
    eventDay.setDate(eventDay.getDate() + 2);
    eventDay.setHours(12, 0, 0, 0);
    document.getElementById('eventDate').value = eventDay.toISOString().slice(0, 16);
    
    const deadline = new Date(eventDay);
    deadline.setHours(9, 0, 0, 0);
    document.getElementById('eventDeadline').value = deadline.toISOString().slice(0, 16);
    
    document.getElementById('eventDate').addEventListener('change', function() {
        const newEventDate = new Date(this.value);
        newEventDate.setHours(9, 0, 0, 0);
        document.getElementById('eventDeadline').value = newEventDate.toISOString().slice(0, 16);
    });
}

function closeModalTemp() {
    const closeModal = document.getElementById('closeEventModalTemp');
    const newModal = document.getElementById('newEventModalTemp');
    if (closeModal) closeModal.remove();
    if (newModal) newModal.remove();
}

async function confirmCloseEvent() {
    closeModalTemp();
    setLoading(true);
    try {
        const response = await fetch(`${API_URL}?action=archivieren&adminPassword=${encodeURIComponent(adminPassword)}`);
        const data = await response.json();
        if (data.success) {
            showMessage(`✅ Event beendet! ${data.archived} Bestellungen archiviert.`, 'success', 'Verwaltung');
            await loadEventStatus();
        } else {
            showMessage(data.error || 'Fehler!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Fehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
}

async function confirmNewEvent() {
    const eventDate = document.getElementById('eventDate').value;
    const deadline = document.getElementById('eventDeadline').value;
    
    if (!eventDate || !deadline) {
        showMessage('Bitte beide Daten angeben!', 'error', 'Verwaltung');
        return;
    }
    
    if (new Date(deadline) > new Date(eventDate)) {
        showMessage('Bestellende muss vor Event liegen!', 'error', 'Verwaltung');
        return;
    }
    
    closeModalTemp();
    setLoading(true);
    
    try {
        const deadlineISO = new Date(deadline).toISOString();
        const response = await fetch(`${API_URL}?action=ausserplanmaessig&adminPassword=${encodeURIComponent(adminPassword)}&deadline=${encodeURIComponent(deadlineISO)}`);
        const data = await response.json();
        
        if (data.success) {
            showMessage('✅ Neues Event gestartet!', 'success', 'Verwaltung');
            await loadEventStatus();
        } else {
            showMessage(data.error || 'Fehler!', 'error', 'Verwaltung');
        }
    } catch (error) {
        showMessage('Fehler: ' + error.message, 'error', 'Verwaltung');
    } finally {
        setLoading(false);
    }
}

// ⬇️⬇️⬇️ HIER EINFÜGEN - Neue Übersicht-Funktionen ⬇️⬇️⬇️

async function loadUebersicht() {
    document.getElementById('loadingUebersicht').style.display = 'block';
    document.getElementById('contentUebersicht').style.display = 'none';
    document.getElementById('emptyStateUebersicht').style.display = 'none';
    
    try {
        // Lade aktuelle Bestellungen und Historie parallel
        const [currentResponse, historieResponse] = await Promise.all([
            fetch(`${API_URL}?action=getAllOrders`),
            fetch(`${API_URL}?type=historie`)
        ]);
        
        const currentData = await currentResponse.json();
        const historieData = await historieResponse.json();
        
        document.getElementById('loadingUebersicht').style.display = 'none';
        
        // Gruppiere Historie nach Event-Datum
        const historieGroups = {};
        if (Array.isArray(historieData) && historieData.length > 0) {
            historieData.forEach(entry => {
                const datum = entry['Event-Datum'] || entry.Datum || 'Unbekannt';
                if (!historieGroups[datum]) {
                    historieGroups[datum] = [];
                }
                historieGroups[datum].push(entry);
            });
        }
        
        // Sortiere Events (neueste zuerst)
		const sortedEvents = Object.keys(historieGroups).sort((a, b) => {
			// Parse deutsche Daten: "Freitag, 24.10.2025" oder "24.10.2025"
		const parseDate = (str) => {
		// 1. ISO-Format: "2025-10-24T22:00:00.000Z"
			if (str.match(/^\d{4}-\d{2}-\d{2}T/)) {
				return new Date(str).getTime();
			}
			
			// 2. Deutsches Format: "24.10.2025" (mit oder ohne Wochentag)
			const match = str.match(/(\d{2})\.(\d{2})\.(\d{4})/);
			if (match) {
				const [_, day, month, year] = match;
				return new Date(year, month - 1, day).getTime();
			}
			
			return 0;
		};
			
			return parseDate(b) - parseDate(a); // Neueste zuerst
		});
       
        // Prüfe ob aktuelles Event läuft
        const hasCurrentEvent = currentData.success && Array.isArray(currentData.orders) && currentData.orders.length > 0;
        
        if (!hasCurrentEvent && sortedEvents.length === 0) {
            document.getElementById('emptyStateUebersicht').style.display = 'block';
            return;
        }
        
        const container = document.getElementById('eventsContainer');
        container.innerHTML = '';
        
        // 1. Aktuelles Event (falls vorhanden)
        if (hasCurrentEvent) {
            container.appendChild(createEventAccordion('current', currentData.orders, true, true));
        }
        
        // 2. Vorhergehendes Event (aufgeklappt)
        if (sortedEvents.length > 0) {
            const lastEvent = sortedEvents[0];
            container.appendChild(createEventAccordion(lastEvent, historieGroups[lastEvent], true, false));
        }
        
        // 3. Ältere Events (zugeklappt)
        for (let i = 1; i < sortedEvents.length; i++) {
            const eventDatum = sortedEvents[i];
            container.appendChild(createEventAccordion(eventDatum, historieGroups[eventDatum], false, false));
        }
        
        document.getElementById('contentUebersicht').style.display = 'block';
    } catch (error) {
        document.getElementById('loadingUebersicht').style.display = 'none';
        document.getElementById('emptyStateUebersicht').style.display = 'block';
        console.error('Fehler beim Laden:', error);
    }
}

function createEventAccordion(eventDatum, orders, isOpen, isCurrent) {
    const accordion = document.createElement('div');
    accordion.className = 'event-accordion' + (isCurrent ? ' current' : '');
    
    // Berechne Statistiken
    let totalWuerste = 0, totalBrezn = 0, totalSum = 0;
    
    orders.forEach(order => {
        const wuerste = parseInt(order['Weißwürste'] || order.Wuerste || order.wuerste || 0);
        const brezn = parseInt(order.Brezn || order.brezn || 0);
        const preisWurst = parseFloat(order['Preis Wurst'] || order.PreisWurst || order.preisWurst || 0);
        const preisBreze = parseFloat(order['Preis Breze'] || order.PreisBreze || order.preisBreze || 0);
        
        totalWuerste += wuerste;
        totalBrezn += brezn;
        totalSum += (wuerste * preisWurst) + (brezn * preisBreze);
    });
    
    const displayDatum = isCurrent ? 'Aktuelles Event' : translateDateToDeutsch(eventDatum);
    const badge = isCurrent ? '<span class="event-badge">🔴 Live</span>' : '';
    
    accordion.innerHTML = `
        <div class="event-header" onclick="toggleEvent(this)">
            <div class="event-title">
                <strong style="font-size: 16px;">${displayDatum}</strong>
                ${badge}
            </div>
			<div class="event-stats">
				<span>👥 ${orders.length}</span>
				<span><img src="https://fevwursten.github.io/weisswurst.png" alt="" style="width: 14px; height: 14px; vertical-align: middle;"> ${totalWuerste}</span>
				<span>🥨 ${totalBrezn}</span>
				<span>${totalSum.toFixed(2).replace('.', ',')} €</span>
			</div>

            <div class="event-toggle ${isOpen ? 'open' : ''}">▼</div>
        </div>
        <div class="event-content ${isOpen ? 'open' : ''}">
            <div class="event-content-inner">
                ${createEventTable(orders, isCurrent)}
                ${createEventSummary(totalWuerste, totalBrezn, totalSum)}
            </div>
        </div>
    `;
    
    return accordion;
}

function createEventTable(orders, isCurrent) {
    let html = `
        <table class="orders-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th class="item-cell">
                        <img src="https://fevwursten.github.io/weisswurst.png" alt="Weißwurst" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 4px;">
                        Würste
                    </th>
                    <th class="item-cell">🥨 Brezn</th>
                    <th style="text-align: right;">Preis/Wurst</th>
                    <th style="text-align: right;">Preis/Breze</th>
                    <th style="text-align: right;">Summe</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    orders.forEach(order => {
        const name = order.Name || order.name || order.Benutzer || '-';
        const wuerste = parseInt(order['Weißwürste'] || order.Wuerste || order.wuerste || 0);
        const brezn = parseInt(order.Brezn || order.brezn || 0);
        const preisWurst = parseFloat(order['Preis Wurst'] || order.PreisWurst || order.preisWurst || 0);
        const preisBreze = parseFloat(order['Preis Breze'] || order.PreisBreze || order.preisBreze || 0);
        const summe = (wuerste * preisWurst) + (brezn * preisBreze);
        
        html += `
            <tr>
                <td class="name-cell">${name}</td>
                <td class="item-cell">${wuerste}</td>
                <td class="item-cell">${brezn}</td>
                <td style="text-align: right;">${preisWurst.toFixed(2).replace('.', ',')} €</td>
                <td style="text-align: right;">${preisBreze.toFixed(2).replace('.', ',')} €</td>
                <td style="text-align: right; font-weight: 600; color: #b9052d;">${summe.toFixed(2).replace('.', ',')} €</td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    return html;
}

function createEventSummary(totalWuerste, totalBrezn, totalSum) {
    return `
        <div class="summary-section" style="margin-top: 24px; padding: 16px;">
            <div style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 16px;">
                <div style="text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">
                        <img src="https://fevwursten.github.io/weisswurst.png" alt="Weißwurst" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 4px;">
                        Würste
                    </div>
                    <div style="font-size: 32px; font-weight: 600;">${totalWuerste}</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">🥨 Brezn</div>
                    <div style="font-size: 32px; font-weight: 600;">${totalBrezn}</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">💰 Gesamt</div>
                    <div style="font-size: 32px; font-weight: 600;">${totalSum.toFixed(2).replace('.', ',')} €</div>
                </div>
            </div>
        </div>
    `;
}


function toggleEvent(header) {
    const accordion = header.parentElement;
    const content = accordion.querySelector('.event-content');
    const toggle = accordion.querySelector('.event-toggle');
    
    const isOpen = content.classList.contains('open');
    
    if (isOpen) {
        content.classList.remove('open');
        toggle.classList.remove('open');
    } else {
        content.classList.add('open');
        toggle.classList.add('open');
    }
}

// ⬆️⬆️⬆️ BIS HIER ⬆️⬆️⬆️

function toggleFilter(type) {
    var buttons = document.querySelectorAll('.filter-btn');
    buttons.forEach(function(btn) {
        btn.classList.remove('active');
    });
    
    var activeBtn = document.querySelector('[data-filter="' + type + '"]');
    if (activeBtn) activeBtn.classList.add('active');
    
    var yearContainer = document.getElementById('yearSelectContainer');
    if (type === 'yearly') {
        yearContainer.style.display = 'block';
    } else {
        yearContainer.style.display = 'none';
    }
    
    loadHallOfFame();
}



// Hall of Fame Funktionen
function loadHallOfFame() {
    document.getElementById('loadingHallOfFame').style.display = 'block';
    document.getElementById('podiumContainer').style.display = 'none';
    document.getElementById('rankingList').style.display = 'none';
    
    fetch(API_URL + '?type=historie')
        .then(function(response) { return response.json(); })
        .then(function(data) {
            var timeframe = document.querySelector('.filter-btn.active').getAttribute('data-filter');
            var filteredData = data;
            
		if (timeframe === 'yearly') {
			var selectedYear = document.getElementById('yearSelect').value;
			filteredData = data.filter(function(entry) {
				var datum = entry['Datum'] || '';
				// Debug: Console log
				console.log('Datum:', datum, 'Jahr:', selectedYear, 'Match:', datum.includes(selectedYear));
				return datum.includes(selectedYear);
			});
			console.log('Gefilterte Daten:', filteredData.length);
		}

            
            var ranking = calculateRanking(filteredData);
            displayHallOfFame(ranking);
        })
        .catch(function(error) {
            console.error('Fehler:', error);
            document.getElementById('loadingHallOfFame').innerHTML = '<p style="color: #b9052d;">Fehler beim Laden</p>';
        });
}

function calculateRanking(data) {
    var userStats = {};
    
    data.forEach(function(entry) {
        var name = entry.Name;
        var wuerste = Number(entry['Weißwürste']) || 0;
        var brezn = Number(entry.Brezn) || 0;
        
        if (!userStats[name]) {
            userStats[name] = { name: name, wuerste: 0, brezn: 0, events: 0 };
        }
        
        userStats[name].wuerste += wuerste;
        userStats[name].brezn += brezn;
        userStats[name].events += 1;
    });
    
    var ranking = Object.keys(userStats).map(function(key) {
        var user = userStats[key];
        return {
            name: user.name,
            wuerste: user.wuerste,
            brezn: user.brezn,
            events: user.events,
            total: user.wuerste + user.brezn
        };
    }).sort(function(a, b) { return b.total - a.total; });
    
    return ranking;
}

function displayHallOfFame(ranking) {
    document.getElementById('loadingHallOfFame').style.display = 'none';
    
    if (ranking.length === 0) {
        document.getElementById('loadingHallOfFame').innerHTML = '<p style="text-align: center;">Noch keine Daten</p>';
        document.getElementById('loadingHallOfFame').style.display = 'block';
        return;
    }
    
    if (ranking.length >= 3) {
        var html = '<div class="podium-container">';
        
        // Platz 2
        html += '<div class="podium-place"><div class="podium-medal">🥈</div>';
        html += '<div class="podium-box second"><div class="podium-name">' + ranking[1].name + '</div>';
        html += '<div class="podium-stats">🥨 ' + ranking[1].wuerste + ' | <img src="https://fevwursten.github.io/weisswurst.png" alt="Weißwurst" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 6px;"> ' + ranking[1].brezn + '<br>';
        html += '📊 ' + ranking[1].total + ' gesamt<br>📅 ' + ranking[1].events + ' Events</div></div></div>';
        
        // Platz 1
        html += '<div class="podium-place"><div class="podium-medal">🥇</div>';
        html += '<div class="podium-box first"><div class="podium-name">' + ranking[0].name + '</div>';
        html += '<div class="podium-stats">🥨 ' + ranking[0].wuerste + ' | <img src="https://fevwursten.github.io/weisswurst.png" alt="Weißwurst" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 6px;"> ' + ranking[0].brezn + '<br>';
        html += '📊 ' + ranking[0].total + ' gesamt<br>📅 ' + ranking[0].events + ' Events</div></div></div>';
        
        // Platz 3
        html += '<div class="podium-place"><div class="podium-medal">🥉</div>';
        html += '<div class="podium-box third"><div class="podium-name">' + ranking[2].name + '</div>';
        html += '<div class="podium-stats">🥨 ' + ranking[2].wuerste + ' | <img src="https://fevwursten.github.io/weisswurst.png" alt="Weißwurst" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 6px;"> ' + ranking[2].brezn + '<br>';
        html += '📊 ' + ranking[2].total + ' gesamt<br>📅 ' + ranking[2].events + ' Events</div></div></div>';
        
        html += '</div>';
        
        document.getElementById('podiumContainer').innerHTML = html;
        document.getElementById('podiumContainer').style.display = 'block';
    }
    
    if (ranking.length > 3) {
        var listHTML = '<h3 style="text-align: center; margin-top: 40px;">Weitere Top-Platzierungen</h3>';
        
        for (var i = 3; i < Math.min(ranking.length, 10); i++) {
            var user = ranking[i];
            listHTML += '<div class="ranking-item"><div class="ranking-rank">' + (i + 1) + '.</div>';
            listHTML += '<div class="ranking-details"><span style="font-weight: 600;">' + user.name + '</span>';
            listHTML += '<span>🥨 ' + user.wuerste + ' | <img src="https://fevwursten.github.io/weisswurst.png" alt="Weißwurst" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 6px;"> ' + user.brezn + '</span>';
            listHTML += '<span>📊 ' + user.total + ' gesamt</span>';
            listHTML += '<span>📅 ' + user.events + ' Events</span></div></div>';
        }
        
        document.getElementById('rankingList').innerHTML = listHTML;
        document.getElementById('rankingList').style.display = 'block';
    }
}



</script>




</script>
</body>
</html>
